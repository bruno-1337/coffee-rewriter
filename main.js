/* THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the GitHub repository of this plugin. */

"use strict";var B=Object.defineProperty;var ge=Object.getOwnPropertyDescriptor;var he=Object.getOwnPropertyNames;var we=Object.prototype.hasOwnProperty;var ve=(n,e)=>{for(var t in e)B(n,t,{get:e[t],enumerable:!0})},ye=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of he(e))!we.call(n,i)&&i!==t&&B(n,i,{get:()=>e[i],enumerable:!(r=ge(e,i))||r.enumerable});return n};var xe=n=>ye(B({},"__esModule",{value:!0}),n);var be={};ve(be,{default:()=>K});module.exports=xe(be);var H=require("obsidian");var y=require("obsidian");var T=require("obsidian");async function Z(n,e,t){let{openAiKey:r,openAiModel:i}=n;if(!r){new T.Notice("Coffee Rewriter: OpenAI key missing. Add it in the settings.");return}try{return(await(0,T.requestUrl)({url:"https://api.openai.com/v1/chat/completions",method:"POST",contentType:"application/json",headers:{Authorization:`Bearer ${r}`},body:JSON.stringify({model:i,messages:[{role:"system",content:t},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content}catch(o){console.error("Coffee Rewriter \u2013 OpenAI error",o),new T.Notice("Coffee Rewriter: OpenAI request failed (see console).");return}}async function _(n){let{openAiKey:e}=n;if(!e)return[];try{let r=(await(0,T.requestUrl)({url:"https://api.openai.com/v1/models",method:"GET",headers:{Authorization:`Bearer ${e}`}})).json;return r&&Array.isArray(r.data)?r.data.map(i=>i.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 OpenAI models error",t),[]}}var A=require("obsidian");async function ee(n,e,t){let{geminiKey:r,geminiModel:i}=n;if(!r){new A.Notice("Coffee Rewriter: Gemini API key missing.");return}try{let o=`https://generativelanguage.googleapis.com/v1beta/models/${i}:generateContent?key=${r}`;return(await(0,A.requestUrl)({url:o,method:"POST",contentType:"application/json",body:JSON.stringify({contents:[{role:"user",parts:[{text:`${t}

${e}`}]}]})})).json?.candidates?.[0]?.content?.parts?.[0]?.text}catch(o){console.error("Coffee Rewriter \u2013 Gemini error",o),new A.Notice("Coffee Rewriter: Gemini request failed (see console).");return}}async function te(n){let{geminiKey:e}=n;if(!e)return[];try{let r=(await(0,A.requestUrl)({url:`https://generativelanguage.googleapis.com/v1beta/models?key=${e}`,method:"GET"})).json;return r&&Array.isArray(r.models)?r.models.map(i=>i.name).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 Gemini models error",t),[]}}var N=require("obsidian");function q(n){return n.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}async function ne(n,e,t){let{lmstudioEndpoint:r,lmStudioModel:i,stripReasoning:o}=n;try{let l=(await(0,N.requestUrl)({url:`${r}/v1/chat/completions`,method:"POST",contentType:"application/json",body:JSON.stringify({model:i,messages:[{role:"system",content:t},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content;return l&&(o?q(l):l)}catch(s){console.error("Coffee Rewriter \u2013 LM Studio error",s),new N.Notice("Coffee Rewriter: Could not reach LM Studio server.");return}}async function re(n){let{lmstudioEndpoint:e}=n;try{let r=(await(0,N.requestUrl)({url:`${e}/v1/models`,method:"GET",contentType:"application/json"})).json;return r&&Array.isArray(r.data)?r.data.map(i=>i.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 LM Studio models",t),[]}}var M=require("obsidian");async function ie(n,e,t){let{claudeKey:r,claudeModel:i}=n;if(!r){new M.Notice("Coffee Rewriter: Claude API key missing. Add it in the settings.");return}try{let s=(await(0,M.requestUrl)({url:"https://api.anthropic.com/v1/messages",method:"POST",contentType:"application/json",headers:{"x-api-key":r,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:i,max_tokens:2048,system:t,messages:[{role:"user",content:e}]})})).json?.content?.[0];return s&&s.type==="text"?s.text:void 0}catch(o){console.error("Coffee Rewriter \u2013 Claude error",o),new M.Notice("Coffee Rewriter: Claude request failed (see console).");return}}async function oe(n){let{claudeKey:e}=n;if(!e)return[];try{let r=(await(0,M.requestUrl)({url:"https://api.anthropic.com/v1/models",method:"GET",contentType:"application/json",headers:{"x-api-key":e,"anthropic-version":"2023-06-01"}})).json;return r&&Array.isArray(r.data)?r.data.map(i=>i.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 Claude models error",t),[]}}var D=require("obsidian");async function se(n,e,t){let{ollamaEndpoint:r,ollamaModel:i,stripReasoning:o}=n;try{let l=(await(0,D.requestUrl)({url:`${r}/v1/chat/completions`,method:"POST",contentType:"application/json",body:JSON.stringify({model:i,messages:[{role:"system",content:t},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content;return l&&(o?q(l):l)}catch(s){console.error("Coffee Rewriter \u2013 Ollama error",s),new D.Notice("Coffee Rewriter: Could not reach Ollama server.");return}}async function le(n){let{ollamaEndpoint:e}=n;try{let r=(await(0,D.requestUrl)({url:`${e}/v1/models`,method:"GET",contentType:"application/json"})).json;return r&&Array.isArray(r.data)?r.data.map(i=>i.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 Ollama models",t),[]}}var J={provider:"openai",openAiKey:"",openAiModel:"gpt-3.5-turbo",geminiKey:"",geminiModel:"gemini-pro",lmstudioEndpoint:"http://localhost:1234",lmStudioModel:"",prompt:"Improve clarity, grammar, and conciseness of the following text. Return only the improved version.",preserveQuotes:!1,stripReasoning:!1,claudeKey:"",claudeModel:"claude-3-haiku-20240307",ollamaEndpoint:"http://localhost:11434",ollamaModel:""},$=class extends y.PluginSettingTab{plugin;constructor(e,t){super(e,t),this.plugin=t}addTextSetting(e,t,r,i,o,s=!1){new y.Setting(e).setName(t).setDesc(r).addText(l=>{s&&(l.inputEl.type="password"),l.setValue(i()).onChange(async a=>{o(a.trim()),await this.plugin.saveSettings()})})}async addModelDropdownSetting(e,t,r,i,o,s){let l=new y.Setting(e).setName(t).setDesc(r),a=null,f=null,p=async d=>{if(!a)return;let u=!1,w="API Key",c="";switch(i){case"openai":u=!!this.plugin.cfg.openAiKey,w="API Key",c="OpenAI API Key";break;case"gemini":u=!!this.plugin.cfg.geminiKey,w="API Key",c="Gemini API Key";break;case"claude":u=!!this.plugin.cfg.claudeKey,w="API Key",c="Claude API Key";break;case"lmstudio":u=!!this.plugin.cfg.lmstudioEndpoint,w="Server URL",c="LM Studio Server URL";break;case"ollama":u=!!this.plugin.cfg.ollamaEndpoint,w="Server URL",c="Ollama Server URL";break;default:a.selectEl.options.length=0,a.addOption("","--Provider error--"),a.setValue(""),a.selectEl.disabled=!0,f&&f.setDisabled(!0),l.setDesc(r+" (Unknown provider configuration)");return}let v=`--Set ${w} First--`,L=`Set ${c} to load models`;if(!u){a.selectEl.options.length=0,a.addOption("",v),a.setValue(""),a.selectEl.disabled=!0,f&&f.setDisabled(!0),l.setDesc(r+` (${L})`);return}a.selectEl.disabled=!0,f&&f.setDisabled(!0),l.setDesc(r+(d?" (Refreshing models...)":" (Loading models...)"));let m=[];try{switch(i){case"openai":m=await _(this.plugin.cfg);break;case"gemini":m=await te(this.plugin.cfg),m=m.map(x=>x.startsWith("models/")?x.split("/")[1]:x);break;case"claude":m=await oe(this.plugin.cfg);break;case"lmstudio":m=await re(this.plugin.cfg);break;case"ollama":m=await le(this.plugin.cfg);break}}catch(x){new y.Notice(`Failed to load models for ${i}. Check console.`),console.error(`Coffee Rewriter - Error loading models for ${i}:`,x)}l.setDesc(r),a.selectEl.disabled=!1,f&&f.setDisabled(!1),a.selectEl.options.length=0,m.length===0?a.addOption("","--No models found or loaded--"):(a.addOption("","--Select Model--"),m.forEach(x=>{a&&a.addOption(x,x)})),a.setValue(o())};l.addDropdown(async d=>{a=d,d.selectEl.options.length=0,d.addOption("","--Select Model--"),d.setValue(o()),d.onChange(async u=>{s(u),await this.plugin.saveSettings()}),await p(!1)}),l.addButton(d=>{f=d,d.setIcon("refresh-cw").setTooltip("Refresh model list").onClick(async()=>{await p(!0)})})}display(){let{containerEl:e}=this;e.empty(),new y.Setting(e).setName("LLM Provider").setDesc("Choose which backend to use for rewriting.").addDropdown(s=>{s.addOption("openai","OpenAI"),s.addOption("gemini","Gemini"),s.addOption("lmstudio","LM Studio"),s.addOption("claude","Claude (Anthropic)"),s.addOption("ollama","Ollama"),s.setValue(this.plugin.cfg.provider).onChange(async l=>{this.plugin.cfg.provider=l,await this.plugin.saveSettings(),this.display()})});let t=this.plugin.cfg.provider;t==="openai"?(this.addTextSetting(e,"API Key","Your OpenAI secret key.",()=>this.plugin.cfg.openAiKey,s=>this.plugin.cfg.openAiKey=s,!0),this.addModelDropdownSetting(e,"Model","OpenAI model.","openai",()=>this.plugin.cfg.openAiModel,s=>this.plugin.cfg.openAiModel=s)):t==="gemini"?(this.addTextSetting(e,"API Key","Google AI API key.",()=>this.plugin.cfg.geminiKey,s=>this.plugin.cfg.geminiKey=s,!0),this.addModelDropdownSetting(e,"Model","Gemini model.","gemini",()=>this.plugin.cfg.geminiModel,s=>this.plugin.cfg.geminiModel=s)):t==="lmstudio"?(this.addTextSetting(e,"Server URL","LM Studio endpoint (http://host:port)",()=>this.plugin.cfg.lmstudioEndpoint,s=>this.plugin.cfg.lmstudioEndpoint=s),this.addModelDropdownSetting(e,"Model","LM Studio model (requires server to be running).","lmstudio",()=>this.plugin.cfg.lmStudioModel,s=>this.plugin.cfg.lmStudioModel=s)):t==="claude"?(this.addTextSetting(e,"API Key","Your Anthropic Claude API key.",()=>this.plugin.cfg.claudeKey,s=>this.plugin.cfg.claudeKey=s,!0),this.addModelDropdownSetting(e,"Model","Claude model.","claude",()=>this.plugin.cfg.claudeModel,s=>this.plugin.cfg.claudeModel=s)):t==="ollama"&&(this.addTextSetting(e,"Server URL","Ollama endpoint (http://host:port)",()=>this.plugin.cfg.ollamaEndpoint,s=>this.plugin.cfg.ollamaEndpoint=s),this.addModelDropdownSetting(e,"Model","Ollama model (requires server to be running).","ollama",()=>this.plugin.cfg.ollamaModel,s=>this.plugin.cfg.ollamaModel=s)),new y.Setting(e).setName("Quick Rewrite Prompt").setDesc("System instruction that precedes the user text. This will be sent to the LLM before your selected text.");let r=e.createDiv("prompt-textarea-container coffee-settings-prompt-container"),i=new y.TextAreaComponent(r).setValue(this.plugin.cfg.prompt).onChange(async s=>{this.plugin.cfg.prompt=s,await this.plugin.saveSettings()});i.inputEl.rows=10,i.inputEl.addClass("coffee-settings-prompt-textarea"),new y.Setting(e).setName("Preserve text inside quotes").setDesc('Do not rewrite text that is wrapped in "double quotes".').addToggle(s=>s.setValue(this.plugin.cfg.preserveQuotes).onChange(async l=>{this.plugin.cfg.preserveQuotes=l,await this.plugin.saveSettings()})),(t==="lmstudio"||t==="ollama")&&new y.Setting(e).setName("Strip <think> reasoning (local models)").setDesc("If your local model emits <think>...</think> blocks, strip them from the final output.").addToggle(s=>s.setValue(this.plugin.cfg.stripReasoning).onChange(async l=>{this.plugin.cfg.stripReasoning=l,await this.plugin.saveSettings()}))}};function Ce(n){return`${n.trim()} Reply with a JSON object that contains two fields: "rewrittenText" with the improved version, and "note" with a brief note about what was changed. Always return valid JSON.`}function Se(n){if(n)try{let e=n.match(/\{[\s\S]*\}/);if(e){let t=e[0],r=JSON.parse(t);if(typeof r.rewrittenText=="string"&&typeof r.note=="string")return r}return{rewrittenText:n.trim(),note:"The AI didn't provide structured feedback for this rewrite."}}catch(e){return console.warn("Coffee Rewriter - Failed to parse LLM response as JSON:",e),{rewrittenText:n.trim(),note:"The AI didn't provide structured feedback for this rewrite."}}}async function k(n,e,t){let r=t!==void 0?t:n.prompt,i=Ce(r),o;switch(n.provider){case"openai":o=await Z(n,e,i);break;case"gemini":o=await ee(n,e,i);break;case"lmstudio":o=await ne(n,e,i);break;case"claude":o=await ie(n,e,i);break;case"ollama":o=await se(n,e,i);break;default:console.warn(`Coffee Rewriter: Unknown provider: ${n.provider}`);return}return Se(o)}var de=require("obsidian"),ae;function b(n,e=4e3){ae?.hide(),ae=new de.Notice(n,e)}var S=require("obsidian");function C(){}C.prototype={diff:function(e,t){var r,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=i.callback;typeof i=="function"&&(o=i,i={}),this.options=i;var s=this;function l(g){return o?(setTimeout(function(){o(void 0,g)},0),!0):g}e=this.castInput(e),t=this.castInput(t),e=this.removeEmpty(this.tokenize(e)),t=this.removeEmpty(this.tokenize(t));var a=t.length,f=e.length,p=1,d=a+f;i.maxEditLength&&(d=Math.min(d,i.maxEditLength));var u=(r=i.timeout)!==null&&r!==void 0?r:1/0,w=Date.now()+u,c=[{oldPos:-1,lastComponent:void 0}],v=this.extractCommon(c[0],t,e,0);if(c[0].oldPos+1>=f&&v+1>=a)return l([{value:this.join(t),count:t.length}]);var L=-1/0,m=1/0;function x(){for(var g=Math.max(L,-p);g<=Math.min(m,p);g+=2){var R=void 0,E=c[g-1],I=c[g+1];E&&(c[g-1]=void 0);var G=!1;if(I){var Y=I.oldPos-g;G=I&&0<=Y&&Y<a}var X=E&&E.oldPos+1<f;if(!G&&!X){c[g]=void 0;continue}if(!X||G&&E.oldPos+1<I.oldPos?R=s.addToPath(I,!0,void 0,0):R=s.addToPath(E,void 0,!0,1),v=s.extractCommon(R,t,e,g),R.oldPos+1>=f&&v+1>=a)return l(Le(s,R.lastComponent,t,e,s.useLongestToken));c[g]=R,R.oldPos+1>=f&&(m=Math.min(m,g-1)),v+1>=a&&(L=Math.max(L,g+1))}p++}if(o)(function g(){setTimeout(function(){if(p>d||Date.now()>w)return o();x()||g()},0)})();else for(;p<=d&&Date.now()<=w;){var Q=x();if(Q)return Q}},addToPath:function(e,t,r,i){var o=e.lastComponent;return o&&o.added===t&&o.removed===r?{oldPos:e.oldPos+i,lastComponent:{count:o.count+1,added:t,removed:r,previousComponent:o.previousComponent}}:{oldPos:e.oldPos+i,lastComponent:{count:1,added:t,removed:r,previousComponent:o}}},extractCommon:function(e,t,r,i){for(var o=t.length,s=r.length,l=e.oldPos,a=l-i,f=0;a+1<o&&l+1<s&&this.equals(t[a+1],r[l+1]);)a++,l++,f++;return f&&(e.lastComponent={count:f,previousComponent:e.lastComponent}),e.oldPos=l,a},equals:function(e,t){return this.options.comparator?this.options.comparator(e,t):e===t||this.options.ignoreCase&&e.toLowerCase()===t.toLowerCase()},removeEmpty:function(e){for(var t=[],r=0;r<e.length;r++)e[r]&&t.push(e[r]);return t},castInput:function(e){return e},tokenize:function(e){return e.split("")},join:function(e){return e.join("")}};function Le(n,e,t,r,i){for(var o=[],s;e;)o.push(e),s=e.previousComponent,delete e.previousComponent,e=s;o.reverse();for(var l=0,a=o.length,f=0,p=0;l<a;l++){var d=o[l];if(d.removed){if(d.value=n.join(r.slice(p,p+d.count)),p+=d.count,l&&o[l-1].added){var w=o[l-1];o[l-1]=o[l],o[l]=w}}else{if(!d.added&&i){var u=t.slice(f,f+d.count);u=u.map(function(v,L){var m=r[p+L];return m.length>v.length?m:v}),d.value=n.join(u)}else d.value=n.join(t.slice(f,f+d.count));f+=d.count,d.added||(p+=d.count)}}var c=o[a-1];return a>1&&typeof c.value=="string"&&(c.added||c.removed)&&n.equals("",c.value)&&(o[a-2].value+=c.value,o.pop()),o}var tt=new C;function Re(n,e){if(typeof n=="function")e.callback=n;else if(n)for(var t in n)n.hasOwnProperty(t)&&(e[t]=n[t]);return e}var fe=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,ce=/\S/,z=new C;z.equals=function(n,e){return this.options.ignoreCase&&(n=n.toLowerCase(),e=e.toLowerCase()),n===e||this.options.ignoreWhitespace&&!ce.test(n)&&!ce.test(e)};z.tokenize=function(n){for(var e=n.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),t=0;t<e.length-1;t++)!e[t+1]&&e[t+2]&&fe.test(e[t])&&fe.test(e[t+2])&&(e[t]+=e[t+2],e.splice(t+1,2),t--);return e};function pe(n,e,t){return t=Re(t,{ignoreWhitespace:!0}),z.diff(n,e,t)}var ue=new C;ue.tokenize=function(n){this.options.stripTrailingCr&&(n=n.replace(/\r\n/g,`
`));var e=[],t=n.split(/(\n|\r\n)/);t[t.length-1]||t.pop();for(var r=0;r<t.length;r++){var i=t[r];r%2&&!this.options.newlineIsToken?e[e.length-1]+=i:(this.options.ignoreWhitespace&&(i=i.trim()),e.push(i))}return e};var Te=new C;Te.tokenize=function(n){return n.split(/(\S.+?[.!?])(?=\s+|$)/)};var Ae=new C;Ae.tokenize=function(n){return n.split(/([{}:;,]|\s+)/)};function j(n){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?j=function(e){return typeof e}:j=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},j(n)}var Me=Object.prototype.toString,P=new C;P.useLongestToken=!0;P.tokenize=ue.tokenize;P.castInput=function(n){var e=this.options,t=e.undefinedReplacement,r=e.stringifyReplacer,i=r===void 0?function(o,s){return typeof s>"u"?t:s}:r;return typeof n=="string"?n:JSON.stringify(U(n,null,null,i),i,"  ")};P.equals=function(n,e){return C.prototype.equals.call(P,n.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"))};function U(n,e,t,r,i){e=e||[],t=t||[],r&&(n=r(i,n));var o;for(o=0;o<e.length;o+=1)if(e[o]===n)return t[o];var s;if(Me.call(n)==="[object Array]"){for(e.push(n),s=new Array(n.length),t.push(s),o=0;o<n.length;o+=1)s[o]=U(n[o],e,t,r,i);return e.pop(),t.pop(),s}if(n&&n.toJSON&&(n=n.toJSON()),j(n)==="object"&&n!==null){e.push(n),s={},t.push(s);var l=[],a;for(a in n)n.hasOwnProperty(a)&&l.push(a);for(l.sort(),o=0;o<l.length;o+=1)a=l[o],s[a]=U(n[a],e,t,r,a);e.pop(),t.pop()}else s=n;return s}var W=new C;W.tokenize=function(n){return n.slice()};W.join=W.removeEmpty=function(n){return n};function me(n,e){let t=0,r=0;return{annotated:pe(n,e).map(o=>{if(o.added){t+=1;let s=o.value,l=s.match(/^(\\s*)/),a=l?l[0]:"",f=s.match(/(\\s*)$/),p=f?f[0]:"",d=s;return p.length>0&&(d=d.substring(0,d.length-p.length)),a.length>0&&(d=d.substring(a.length)),d.length>0?`${a}==${d}==${p}`:`==${s}==`}return o.removed?(r+=1,""):o.value}).join(""),additions:t,removals:r}}var O=class extends S.Modal{originalText;rewrittenText;rewriteNote;onAcceptAll;showDiff;constructor(e,t,r,i,o=!0,s){super(e),this.originalText=t,this.rewrittenText=r,this.rewriteNote=s,this.onAcceptAll=i,this.showDiff=o}onOpen(){let{contentEl:e}=this;if(e.empty(),e.addClass("coffee-rewrite-modal"),e.createEl("h2",{text:"Review Rewrite"}),this.rewriteNote){let l=e.createDiv("note-container");l.createEl("h4",{text:"Note from the AI"}),l.createDiv("note-content").setText(this.rewriteNote)}let t=e.createDiv("text-container original-text-container");t.createEl("h4",{text:"Original"});let r=t.createDiv("modal-text-content");S.MarkdownRenderer.render(this.app,this.originalText,r,"",this);let i=e.createDiv("text-container rewritten-text-container"),o=this.showDiff?"Rewritten (changes highlighted)":"Rewritten Text";i.createEl("h4",{text:o});let s=i.createDiv("modal-text-content");if(this.showDiff){let a=me(this.originalText,this.rewrittenText).annotated;S.MarkdownRenderer.render(this.app,a,s,"",this)}else S.MarkdownRenderer.render(this.app,this.rewrittenText,s,"",this);new S.Setting(e).addButton(l=>l.setButtonText("Accept").setCta().onClick(()=>{this.onAcceptAll(this.rewrittenText),this.close()})).addButton(l=>l.setButtonText("Cancel").onClick(()=>{this.close()}))}onClose(){let{contentEl:e}=this;e.empty()}};async function V(n,e){let t=e.getSelection(),r=!!t,i=t||e.getLine(e.getCursor().line),o=e.getCursor().line,s=r?null:e.getLine(o);if(!i.trim()){b("Coffee Rewriter: Nothing to rewrite.");return}b("\u2615\uFE0F Calling LLM to rewrite text...");let l=await k(n.cfg,i);if(!l){b("Coffee Rewriter: Rewrite request failed or returned empty.");return}let a=l.rewrittenText.trim(),f=l.note;if(a===i.trim()){b("\u2705 Text looks good, nothing to change.");return}let p=a;if(n.cfg.preserveQuotes){let u=i.match(/"([^"]+)"/g)||[],w=p.match(/"([^"]+)"/g)||[];if(u.length===w.length){let c=p;for(let v=0;v<u.length;v++)c=c.replace(w[v],u[v]);p=c}}let d=u=>{r?e.replaceSelection(u):s!==null&&e.replaceRange(u,{line:o,ch:0},{line:o,ch:s.length}),b("\u2615\uFE0F Rewrite accepted!")};new O(n.app,i,p,d,!0,f).open()}var h=require("obsidian");var F=class extends h.Modal{selectedText;plugin;editor;promptTextArea;constructor(e,t,r,i){super(e),this.selectedText=t,this.plugin=r,this.editor=i}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("coffee-tailored-prompt-modal"),e.createEl("h2",{text:"Tailor Rewrite Prompt"}),e.createEl("h4",{text:"Text to Rewrite:"});let t=e.createDiv("modal-selected-text-display");h.MarkdownRenderer.render(this.app,this.selectedText,t,"",this);let r=new h.Setting(e).setName("Prompt:").setDesc("Enter the specific instructions for rewriting the text above. Example: Make this more formal."),i=e.createDiv();i.addClass("coffee-tailored-prompt-input-container"),i.style.width="100%",this.promptTextArea=new h.TextAreaComponent(i).setValue("Rewrite this text ").setPlaceholder("e.g., Make this more concise, or Explain this like I'm five...");let o=this.promptTextArea.inputEl;o.rows=6,o.style.width="100%",new h.Setting(e).addButton(s=>s.setButtonText("Rewrite").setCta().onClick(async()=>{let l=this.promptTextArea.getValue();if(!l.trim()){new h.Notice("Please enter a prompt.");return}this.close(),await this.handleRewrite(l)})).addButton(s=>s.setButtonText("Cancel").onClick(()=>{this.close()}))}async handleRewrite(e){new h.Notice("\u2615\uFE0F Calling LLM with tailored prompt...");let t=await k(this.plugin.cfg,this.selectedText,e);if(!t){new h.Notice("Coffee Rewriter: Tailored rewrite request failed or returned empty.");return}let r=t.rewrittenText,i=t.note,o=r.trim();if(o===this.selectedText.trim()){new h.Notice("\u2705 Text looks good, tailored prompt resulted in no changes.");return}let s=l=>{if(this.editor.getSelection()===this.selectedText)this.editor.replaceSelection(l);else{let f=this.editor.listSelections()[0];if(f)this.editor.replaceRange(l,f.anchor,f.head);else{new h.Notice("Could not apply rewrite: editor selection changed.");return}}new h.Notice("\u2615\uFE0F Tailored rewrite accepted!")};new O(this.app,this.selectedText,o,s,!1,i).open()}onClose(){let{contentEl:e}=this;e.empty()}};var K=class extends H.Plugin{settings=J;async onload(){await this.loadSettings(),this.addSettingTab(new $(this.app,this)),this.addCommand({id:"coffee-quick-rewrite",name:"Quick Rewrite (Paragraph / Selection)",editorCallback:e=>V(this,e),icon:"bot"}),this.addCommand({id:"coffee-tailored-rewrite",name:"Tailored rewrite",editorCallback:e=>{let t=e.getSelection()||e.getLine(e.getCursor().line);if(!t.trim()){new H.Notice("Nothing selected to rewrite.");return}new F(this.app,t,this,e).open()},icon:"edit"}),this.registerEvent(this.app.workspace.on("editor-menu",(e,t)=>{e.addItem(r=>{r.setTitle("Quick Rewrite (selection)").setIcon("bot").onClick(()=>V(this,t))}),e.addItem(r=>{r.setTitle("Tailored rewrite").setIcon("bot").onClick(()=>{let i=t.getSelection()||t.getLine(t.getCursor().line);if(!i.trim()){new H.Notice("Nothing selected to rewrite.");return}new F(this.app,i,this,t).open()})})})),console.info("Coffee Rewriter loaded \u2615\uFE0F")}onunload(){console.info("Coffee Rewriter unloaded \u2615\uFE0F")}async loadSettings(){this.settings=Object.assign({},J,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}get cfg(){return this.settings}};
