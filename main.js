/* THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the GitHub repository of this plugin. */

"use strict";var J=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var ve=Object.getOwnPropertyNames;var ye=Object.prototype.hasOwnProperty;var Te=(i,e)=>{for(var t in e)J(i,t,{get:e[t],enumerable:!0})},Ce=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ve(e))!ye.call(i,n)&&n!==t&&J(i,n,{get:()=>e[n],enumerable:!(r=we(e,n))||r.enumerable});return i};var xe=i=>Ce(J({},"__esModule",{value:!0}),i);var Ie={};Te(Ie,{default:()=>z});module.exports=xe(Ie);var q=require("obsidian");var w=require("obsidian");var A=require("obsidian");async function ee(i,e,t){let{openAiKey:r,openAiModel:n}=i;if(!r){new A.Notice("Coffee Rewriter: OpenAI key missing. Add it in the settings.");return}try{return(await(0,A.requestUrl)({url:"https://api.openai.com/v1/chat/completions",method:"POST",contentType:"application/json",headers:{Authorization:`Bearer ${r}`},body:JSON.stringify({model:n,messages:[{role:"system",content:t},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content}catch(o){console.error("Coffee Rewriter \u2013 OpenAI error",o),new A.Notice("Coffee Rewriter: OpenAI request failed (see console).");return}}async function te(i){let{openAiKey:e}=i;if(!e)return[];try{let r=(await(0,A.requestUrl)({url:"https://api.openai.com/v1/models",method:"GET",headers:{Authorization:`Bearer ${e}`}})).json;return r&&Array.isArray(r.data)?r.data.map(n=>n.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 OpenAI models error",t),[]}}var P=require("obsidian");async function ne(i,e,t){let{geminiKey:r,geminiModel:n}=i;if(!r){new P.Notice("Coffee Rewriter: Gemini API key missing.");return}try{let o=`https://generativelanguage.googleapis.com/v1beta/models/${n}:generateContent?key=${r}`;return(await(0,P.requestUrl)({url:o,method:"POST",contentType:"application/json",body:JSON.stringify({contents:[{role:"user",parts:[{text:`${t}

${e}`}]}]})})).json?.candidates?.[0]?.content?.parts?.[0]?.text}catch(o){console.error("Coffee Rewriter \u2013 Gemini error",o),new P.Notice("Coffee Rewriter: Gemini request failed (see console).");return}}async function ie(i){let{geminiKey:e}=i;if(!e)return[];try{let r=(await(0,P.requestUrl)({url:`https://generativelanguage.googleapis.com/v1beta/models?key=${e}`,method:"GET"})).json;return r&&Array.isArray(r.models)?r.models.map(n=>n.name).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 Gemini models error",t),[]}}var N=require("obsidian");function $(i){return i.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}async function re(i,e,t){let{lmstudioEndpoint:r,lmStudioModel:n,stripReasoning:o}=i;try{let l=(await(0,N.requestUrl)({url:`${r}/v1/chat/completions`,method:"POST",contentType:"application/json",body:JSON.stringify({model:n,messages:[{role:"system",content:t},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content;return l&&(o?$(l):l)}catch(s){console.error("Coffee Rewriter \u2013 LM Studio error",s),new N.Notice("Coffee Rewriter: Could not reach LM Studio server.");return}}async function oe(i){let{lmstudioEndpoint:e}=i;try{let r=(await(0,N.requestUrl)({url:`${e}/v1/models`,method:"GET",contentType:"application/json"})).json;return r&&Array.isArray(r.data)?r.data.map(n=>n.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 LM Studio models",t),[]}}var b=require("obsidian");async function se(i,e,t){let{claudeKey:r,claudeModel:n}=i;if(!r){new b.Notice("Coffee Rewriter: Claude API key missing. Add it in the settings.");return}try{let s=(await(0,b.requestUrl)({url:"https://api.anthropic.com/v1/messages",method:"POST",contentType:"application/json",headers:{"x-api-key":r,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:n,max_tokens:2048,system:t,messages:[{role:"user",content:e}]})})).json?.content?.[0];return s&&s.type==="text"?s.text:void 0}catch(o){console.error("Coffee Rewriter \u2013 Claude error",o),new b.Notice("Coffee Rewriter: Claude request failed (see console).");return}}async function le(i){let{claudeKey:e}=i;if(!e)return[];try{let r=(await(0,b.requestUrl)({url:"https://api.anthropic.com/v1/models",method:"GET",contentType:"application/json",headers:{"x-api-key":e,"anthropic-version":"2023-06-01"}})).json;return r&&Array.isArray(r.data)?r.data.map(n=>n.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 Claude models error",t),[]}}var D=require("obsidian");async function ae(i,e,t){let{ollamaEndpoint:r,ollamaModel:n,stripReasoning:o}=i;try{let l=(await(0,D.requestUrl)({url:`${r}/v1/chat/completions`,method:"POST",contentType:"application/json",body:JSON.stringify({model:n,messages:[{role:"system",content:t},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content;return l&&(o?$(l):l)}catch(s){console.error("Coffee Rewriter \u2013 Ollama error",s),new D.Notice("Coffee Rewriter: Could not reach Ollama server.");return}}async function pe(i){let{ollamaEndpoint:e}=i;try{let r=(await(0,D.requestUrl)({url:`${e}/v1/models`,method:"GET",contentType:"application/json"})).json;return r&&Array.isArray(r.data)?r.data.map(n=>n.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 Ollama models",t),[]}}var C=require("obsidian"),F=class extends C.Modal{plugin;template;isNew;onSave;nameInput;promptInput;constructor(e,t,r,n){super(e),this.plugin=t,this.onSave=n,r?(this.isNew=!1,this.template={...r}):(this.isNew=!0,this.template={id:`custom-${new Date().getTime()}`,name:"",prompt:""})}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("coffee-prompt-edit-modal"),e.createEl("h2",{text:this.isNew?"Add New Prompt Template":"Edit Prompt Template"});let t=!this.isNew&&this.plugin.cfg.promptTemplates.length>0&&this.plugin.cfg.promptTemplates[0].id===this.template.id;t||new C.Setting(e).setName("Template Name").addText(r=>{this.nameInput=r,r.setValue(this.template.name).setPlaceholder("Enter template name (e.g., Summarize for Twitter)")}),new C.Setting(e).setName("Prompt Content"),this.promptInput=new C.TextAreaComponent(e).setValue(this.template.prompt).setPlaceholder("Enter the full prompt here. The selected text will be appended when used."),this.promptInput.inputEl.rows=8,this.promptInput.inputEl.addClass("coffee-settings-prompt-textarea"),this.promptInput.inputEl.style.width="100%",this.promptInput.inputEl.style.marginTop="var(--size-2-2)",new C.Setting(e).addButton(r=>r.setButtonText("Save").setCta().onClick(()=>{if(this.nameInput&&(this.template.name=this.nameInput.getValue().trim()),this.template.prompt=this.promptInput.getValue().trim(),!this.template.name&&!t){new C.Notice("Template name cannot be empty.");return}else t&&(this.template.name=this.plugin.cfg.promptTemplates[0].name);if(!this.template.prompt){new C.Notice("Prompt content cannot be empty.");return}this.onSave({action:"save",template:this.template}),this.close()})).addButton(r=>r.setButtonText("Cancel").onClick(()=>{this.close()}))}onClose(){let{contentEl:e}=this;e.empty()}};var B={provider:"openai",openAiKey:"",openAiModel:"gpt-3.5-turbo",geminiKey:"",geminiModel:"gemini-pro",lmstudioEndpoint:"http://localhost:1234",lmStudioModel:"",promptTemplates:[{id:"default-quick-rewrite",name:"Quick Rewrite",prompt:"Improve clarity, grammar, and conciseness of the following text."},{id:"pirate-speak",name:"Pirate Speak",prompt:"Rewrite the following text as if you were a swashbuckling pirate, arrr! Keep the core meaning but infuse it with pirate slang and bravado."},{id:"professional-tone",name:"Professional Tone",prompt:"Please rewrite the following text in a more professional and formal tone. Ensure clarity, conciseness, and appropriate business language. Avoid jargon where possible, or explain it if necessary."},{id:"academic-phd-style",name:"Academic (PhD Style)",prompt:"Please revise the following text to reflect the style, depth, and rigor of a PhD-level academic paper. Focus on sophisticated vocabulary, nuanced argumentation, formal scholarly tone, and logical precision."}],preserveQuotes:!1,stripReasoning:!1,claudeKey:"",claudeModel:"claude-3-haiku-20240307",ollamaEndpoint:"http://localhost:11434",ollamaModel:""},j=class extends w.PluginSettingTab{plugin;selectedTemplateIdForEditing=null;promptTemplateSettingsContainer;constructor(e,t){super(e,t),this.plugin=t,this.plugin.cfg.promptTemplates&&this.plugin.cfg.promptTemplates.length>0&&(this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id)}addTextSetting(e,t,r,n,o,s=!1){new w.Setting(e).setName(t).setDesc(r).addText(l=>{s&&(l.inputEl.type="password"),l.setValue(n()).onChange(async a=>{o(a.trim()),await this.plugin.saveSettings()})})}async addModelDropdownSetting(e,t,r,n,o,s){let l=new w.Setting(e).setName(t).setDesc(r),a=null,d=null,f=async p=>{if(!a)return;let m=!1,v="API Key",c="";switch(n){case"openai":m=!!this.plugin.cfg.openAiKey,v="API Key",c="OpenAI API Key";break;case"gemini":m=!!this.plugin.cfg.geminiKey,v="API Key",c="Gemini API Key";break;case"claude":m=!!this.plugin.cfg.claudeKey,v="API Key",c="Claude API Key";break;case"lmstudio":m=!!this.plugin.cfg.lmstudioEndpoint,v="Server URL",c="LM Studio Server URL";break;case"ollama":m=!!this.plugin.cfg.ollamaEndpoint,v="Server URL",c="Ollama Server URL";break;default:a.selectEl.options.length=0,a.addOption("","--Provider error--"),a.setValue(""),a.selectEl.disabled=!0,d&&d.setDisabled(!0),l.setDesc(r+" (Unknown provider configuration)");return}let y=`--Set ${v} First--`,R=`Set ${c} to load models`;if(!m){a.selectEl.options.length=0,a.addOption("",y),a.setValue(""),a.selectEl.disabled=!0,d&&d.setDisabled(!0),l.setDesc(r+` (${R})`);return}a.selectEl.disabled=!0,d&&d.setDisabled(!0),l.setDesc(r+(p?" (Refreshing models...)":" (Loading models...)"));let u=[];try{switch(n){case"openai":u=await te(this.plugin.cfg);break;case"gemini":u=await ie(this.plugin.cfg),u=u.map(T=>T.startsWith("models/")?T.split("/")[1]:T);break;case"claude":u=await le(this.plugin.cfg);break;case"lmstudio":u=await oe(this.plugin.cfg);break;case"ollama":u=await pe(this.plugin.cfg);break}}catch(T){new w.Notice(`Failed to load models for ${n}. Check console.`),console.error(`Coffee Rewriter - Error loading models for ${n}:`,T)}l.setDesc(r),a.selectEl.disabled=!1,d&&d.setDisabled(!1),a.selectEl.options.length=0,u.length===0?a.addOption("","--No models found or loaded--"):(a.addOption("","--Select Model--"),u.forEach(T=>{a&&a.addOption(T,T)})),a.setValue(o())};l.addDropdown(async p=>{a=p,p.selectEl.options.length=0,p.addOption("","--Select Model--"),p.setValue(o()),p.onChange(async m=>{s(m),await this.plugin.saveSettings()}),await f(!1)}),l.addButton(p=>{d=p,p.setIcon("refresh-cw").setTooltip("Refresh model list").onClick(async()=>{await f(!0)})})}renderPromptTemplateEditor(){this.promptTemplateSettingsContainer.empty(),(!this.plugin.cfg.promptTemplates||this.plugin.cfg.promptTemplates.length===0)&&(this.plugin.cfg.promptTemplates=B.promptTemplates.map(n=>({...n})),this.plugin.saveSettings(),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates.length>0?this.plugin.cfg.promptTemplates[0].id:null),!this.selectedTemplateIdForEditing&&this.plugin.cfg.promptTemplates.length>0?this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id:this.plugin.cfg.promptTemplates.length===0&&(this.selectedTemplateIdForEditing=null);let e=new w.Setting(this.promptTemplateSettingsContainer).setName("Manage Templates");e.addButton(n=>n.setIcon("plus").setTooltip("Add new prompt template").setCta().onClick(()=>{new F(this.app,this.plugin,null,this.handlePromptSaveAction.bind(this)).open()})),e.addDropdown(n=>{this.plugin.cfg.promptTemplates.length===0?(n.addOption("__none__","-- No templates defined --"),n.setDisabled(!0)):this.plugin.cfg.promptTemplates.forEach(o=>{n.addOption(o.id,o.name)}),this.selectedTemplateIdForEditing?n.setValue(this.selectedTemplateIdForEditing):this.plugin.cfg.promptTemplates.length>0&&(n.setValue(this.plugin.cfg.promptTemplates[0].id),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id),n.onChange(async o=>{this.selectedTemplateIdForEditing=o,this.renderPromptTemplateEditor()})}),e.addButton(n=>n.setIcon("pencil").setTooltip("Edit selected prompt template").onClick(()=>{let o=this.plugin.cfg.promptTemplates.find(s=>s.id===this.selectedTemplateIdForEditing);o?new F(this.app,this.plugin,o,this.handlePromptSaveAction.bind(this)).open():new w.Notice("No template selected to edit. Please add one first if the list is empty.")}));let t=this.plugin.cfg.promptTemplates.find(n=>n.id===this.selectedTemplateIdForEditing),r=t?this.plugin.cfg.promptTemplates.indexOf(t)===0:!1;if(t&&!r&&e.addButton(n=>n.setIcon("trash").setTooltip("Delete selected prompt template").setWarning().onClick(async()=>{let o=this.plugin.cfg.promptTemplates.findIndex(s=>s.id===this.selectedTemplateIdForEditing);o>0?(this.plugin.cfg.promptTemplates.splice(o,1),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id,await this.plugin.saveSettings(),this.renderPromptTemplateEditor()):new w.Notice("Cannot delete this template.")})),t){new w.Setting(this.promptTemplateSettingsContainer).setName("Selected Prompt Content").setDesc("Content of the template selected above. Click the pencil icon to edit.");let n=this.promptTemplateSettingsContainer.createDiv({cls:"coffee-prompt-display-box"});n.setText(t.prompt),n.style.width="100%",n.style.padding="var(--size-2-3)",n.style.border="1px solid var(--background-modifier-border)",n.style.borderRadius="var(--radius-m)",n.style.backgroundColor="var(--background-secondary)",n.style.whiteSpace="pre-wrap",n.style.wordBreak="break-word",n.style.maxHeight="150px",n.style.overflowY="auto",n.style.marginTop="var(--size-2-2)",n.style.marginBottom="var(--size-4-4)"}else this.plugin.cfg.promptTemplates.length>0&&this.selectedTemplateIdForEditing&&new w.Setting(this.promptTemplateSettingsContainer).setName("Error").setDesc("Could not display selected prompt. Please try selecting again.")}async handlePromptSaveAction(e){let t=!1,r=this.selectedTemplateIdForEditing;if(e.action==="save"){let{template:n}=e,o=this.plugin.cfg.promptTemplates.findIndex(s=>s.id===n.id);o>-1?this.plugin.cfg.promptTemplates[o]=n:(this.plugin.cfg.promptTemplates.push(n),r=n.id),t=!0}t&&(this.selectedTemplateIdForEditing=r,await this.plugin.saveSettings(),this.renderPromptTemplateEditor())}display(){let{containerEl:e}=this;e.empty(),e.createEl("h3",{text:"LLM Provider Settings"}),new w.Setting(e).setName("LLM Provider").setDesc("Choose which backend to use for rewriting.").addDropdown(n=>{n.addOption("openai","OpenAI"),n.addOption("gemini","Gemini"),n.addOption("lmstudio","LM Studio"),n.addOption("claude","Claude (Anthropic)"),n.addOption("ollama","Ollama"),n.setValue(this.plugin.cfg.provider).onChange(async o=>{this.plugin.cfg.provider=o,await this.plugin.saveSettings(),this.display()})});let t=this.plugin.cfg.provider;t==="openai"?(this.addTextSetting(e,"API Key","Your OpenAI secret key.",()=>this.plugin.cfg.openAiKey,n=>this.plugin.cfg.openAiKey=n,!0),this.addModelDropdownSetting(e,"Model","OpenAI model.","openai",()=>this.plugin.cfg.openAiModel,n=>this.plugin.cfg.openAiModel=n)):t==="gemini"?(this.addTextSetting(e,"API Key","Google AI API key.",()=>this.plugin.cfg.geminiKey,n=>this.plugin.cfg.geminiKey=n,!0),this.addModelDropdownSetting(e,"Model","Gemini model.","gemini",()=>this.plugin.cfg.geminiModel,n=>this.plugin.cfg.geminiModel=n)):t==="lmstudio"?(this.addTextSetting(e,"Server URL","LM Studio endpoint (http://host:port)",()=>this.plugin.cfg.lmstudioEndpoint,n=>this.plugin.cfg.lmstudioEndpoint=n),this.addModelDropdownSetting(e,"Model","LM Studio model (requires server to be running).","lmstudio",()=>this.plugin.cfg.lmStudioModel,n=>this.plugin.cfg.lmStudioModel=n)):t==="claude"?(this.addTextSetting(e,"API Key","Your Anthropic Claude API key.",()=>this.plugin.cfg.claudeKey,n=>this.plugin.cfg.claudeKey=n,!0),this.addModelDropdownSetting(e,"Model","Claude model.","claude",()=>this.plugin.cfg.claudeModel,n=>this.plugin.cfg.claudeModel=n)):t==="ollama"&&(this.addTextSetting(e,"Server URL","Ollama endpoint (http://host:port)",()=>this.plugin.cfg.ollamaEndpoint,n=>this.plugin.cfg.ollamaEndpoint=n),this.addModelDropdownSetting(e,"Model","Ollama model (requires server to be running).","ollama",()=>this.plugin.cfg.ollamaModel,n=>this.plugin.cfg.ollamaModel=n)),e.createEl("h3",{text:"Prompts"}),this.promptTemplateSettingsContainer=e.createDiv("prompt-templates-settings-area"),this.renderPromptTemplateEditor(),e.createEl("h3",{text:"Other Settings"}),new w.Setting(e).setName("Preserve text inside quotes").setDesc('Do not rewrite text that is wrapped in "double quotes".').addToggle(n=>n.setValue(this.plugin.cfg.preserveQuotes).onChange(async o=>{this.plugin.cfg.preserveQuotes=o,await this.plugin.saveSettings()})),(t==="lmstudio"||t==="ollama")&&new w.Setting(e).setName("Strip <think> reasoning (local models)").setDesc("If your local model emits <think>...</think> blocks, strip them from the final output.").addToggle(n=>n.setValue(this.plugin.cfg.stripReasoning).onChange(async o=>{this.plugin.cfg.stripReasoning=o,await this.plugin.saveSettings()}))}};function Se(i){return`${i.trim()} Reply with ONLY ONE JSON object containing two fields: "rewrittenText" (containing the entire improved version as a single string, including any lists or paragraphs) and "note" (containing a brief note about what was changed). Always return a single, valid JSON object. Do not return a list of JSON objects.`}function Re(i){if(i)try{let e=i.match(/\{[\s\S]*\}/);if(e){let t=e[0],r=JSON.parse(t);if(typeof r.rewrittenText=="string"&&typeof r.note=="string")return r}return{rewrittenText:i.trim(),note:"The AI didn't provide structured feedback for this rewrite."}}catch(e){return console.warn("Coffee Rewriter - Failed to parse LLM response as JSON:",e),{rewrittenText:i.trim(),note:"The AI didn't provide structured feedback for this rewrite."}}}async function U(i,e,t){let r;t!==void 0?r=t:i.promptTemplates&&i.promptTemplates.length>0&&i.promptTemplates[0]&&typeof i.promptTemplates[0].prompt=="string"?r=i.promptTemplates[0].prompt:(console.warn("Coffee Rewriter: Default prompt template not found or invalid. Using a fallback prompt."),r="Improve the following text.");let n=Se(r),o;switch(i.provider){case"openai":o=await ee(i,e,n);break;case"gemini":o=await ne(i,e,n);break;case"lmstudio":o=await re(i,e,n);break;case"claude":o=await se(i,e,n);break;case"ollama":o=await ae(i,e,n);break;default:console.warn(`Coffee Rewriter: Unknown provider: ${i.provider}`);return}return Re(o)}var fe=require("obsidian"),de;function E(i,e=4e3){de?.hide(),de=new fe.Notice(i,e)}var S=require("obsidian");function x(){}x.prototype={diff:function(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=n.callback;typeof n=="function"&&(o=n,n={}),this.options=n;var s=this;function l(g){return o?(setTimeout(function(){o(void 0,g)},0),!0):g}e=this.castInput(e),t=this.castInput(t),e=this.removeEmpty(this.tokenize(e)),t=this.removeEmpty(this.tokenize(t));var a=t.length,d=e.length,f=1,p=a+d;n.maxEditLength&&(p=Math.min(p,n.maxEditLength));var m=(r=n.timeout)!==null&&r!==void 0?r:1/0,v=Date.now()+m,c=[{oldPos:-1,lastComponent:void 0}],y=this.extractCommon(c[0],t,e,0);if(c[0].oldPos+1>=d&&y+1>=a)return l([{value:this.join(t),count:t.length}]);var R=-1/0,u=1/0;function T(){for(var g=Math.max(R,-f);g<=Math.min(u,f);g+=2){var L=void 0,M=c[g-1],O=c[g+1];M&&(c[g-1]=void 0);var G=!1;if(O){var Z=O.oldPos-g;G=O&&0<=Z&&Z<a}var _=M&&M.oldPos+1<d;if(!G&&!_){c[g]=void 0;continue}if(!_||G&&M.oldPos+1<O.oldPos?L=s.addToPath(O,!0,void 0,0):L=s.addToPath(M,void 0,!0,1),y=s.extractCommon(L,t,e,g),L.oldPos+1>=d&&y+1>=a)return l(Le(s,L.lastComponent,t,e,s.useLongestToken));c[g]=L,L.oldPos+1>=d&&(u=Math.min(u,g-1)),y+1>=a&&(R=Math.max(R,g+1))}f++}if(o)(function g(){setTimeout(function(){if(f>p||Date.now()>v)return o();T()||g()},0)})();else for(;f<=p&&Date.now()<=v;){var X=T();if(X)return X}},addToPath:function(e,t,r,n){var o=e.lastComponent;return o&&o.added===t&&o.removed===r?{oldPos:e.oldPos+n,lastComponent:{count:o.count+1,added:t,removed:r,previousComponent:o.previousComponent}}:{oldPos:e.oldPos+n,lastComponent:{count:1,added:t,removed:r,previousComponent:o}}},extractCommon:function(e,t,r,n){for(var o=t.length,s=r.length,l=e.oldPos,a=l-n,d=0;a+1<o&&l+1<s&&this.equals(t[a+1],r[l+1]);)a++,l++,d++;return d&&(e.lastComponent={count:d,previousComponent:e.lastComponent}),e.oldPos=l,a},equals:function(e,t){return this.options.comparator?this.options.comparator(e,t):e===t||this.options.ignoreCase&&e.toLowerCase()===t.toLowerCase()},removeEmpty:function(e){for(var t=[],r=0;r<e.length;r++)e[r]&&t.push(e[r]);return t},castInput:function(e){return e},tokenize:function(e){return e.split("")},join:function(e){return e.join("")}};function Le(i,e,t,r,n){for(var o=[],s;e;)o.push(e),s=e.previousComponent,delete e.previousComponent,e=s;o.reverse();for(var l=0,a=o.length,d=0,f=0;l<a;l++){var p=o[l];if(p.removed){if(p.value=i.join(r.slice(f,f+p.count)),f+=p.count,l&&o[l-1].added){var v=o[l-1];o[l-1]=o[l],o[l]=v}}else{if(!p.added&&n){var m=t.slice(d,d+p.count);m=m.map(function(y,R){var u=r[f+R];return u.length>y.length?u:y}),p.value=i.join(m)}else p.value=i.join(t.slice(d,d+p.count));d+=p.count,p.added||(f+=p.count)}}var c=o[a-1];return a>1&&typeof c.value=="string"&&(c.added||c.removed)&&i.equals("",c.value)&&(o[a-2].value+=c.value,o.pop()),o}var pt=new x;function Ae(i,e){if(typeof i=="function")e.callback=i;else if(i)for(var t in i)i.hasOwnProperty(t)&&(e[t]=i[t]);return e}var ce=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,me=/\S/,Q=new x;Q.equals=function(i,e){return this.options.ignoreCase&&(i=i.toLowerCase(),e=e.toLowerCase()),i===e||this.options.ignoreWhitespace&&!me.test(i)&&!me.test(e)};Q.tokenize=function(i){for(var e=i.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),t=0;t<e.length-1;t++)!e[t+1]&&e[t+2]&&ce.test(e[t])&&ce.test(e[t+2])&&(e[t]+=e[t+2],e.splice(t+1,2),t--);return e};function ue(i,e,t){return t=Ae(t,{ignoreWhitespace:!0}),Q.diff(i,e,t)}var ge=new x;ge.tokenize=function(i){this.options.stripTrailingCr&&(i=i.replace(/\r\n/g,`
`));var e=[],t=i.split(/(\n|\r\n)/);t[t.length-1]||t.pop();for(var r=0;r<t.length;r++){var n=t[r];r%2&&!this.options.newlineIsToken?e[e.length-1]+=n:(this.options.ignoreWhitespace&&(n=n.trim()),e.push(n))}return e};var Pe=new x;Pe.tokenize=function(i){return i.split(/(\S.+?[.!?])(?=\s+|$)/)};var be=new x;be.tokenize=function(i){return i.split(/([{}:;,]|\s+)/)};function K(i){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?K=function(e){return typeof e}:K=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},K(i)}var Ee=Object.prototype.toString,k=new x;k.useLongestToken=!0;k.tokenize=ge.tokenize;k.castInput=function(i){var e=this.options,t=e.undefinedReplacement,r=e.stringifyReplacer,n=r===void 0?function(o,s){return typeof s>"u"?t:s}:r;return typeof i=="string"?i:JSON.stringify(V(i,null,null,n),n,"  ")};k.equals=function(i,e){return x.prototype.equals.call(k,i.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"))};function V(i,e,t,r,n){e=e||[],t=t||[],r&&(i=r(n,i));var o;for(o=0;o<e.length;o+=1)if(e[o]===i)return t[o];var s;if(Ee.call(i)==="[object Array]"){for(e.push(i),s=new Array(i.length),t.push(s),o=0;o<i.length;o+=1)s[o]=V(i[o],e,t,r,n);return e.pop(),t.pop(),s}if(i&&i.toJSON&&(i=i.toJSON()),K(i)==="object"&&i!==null){e.push(i),s={},t.push(s);var l=[],a;for(a in i)i.hasOwnProperty(a)&&l.push(a);for(l.sort(),o=0;o<l.length;o+=1)a=l[o],s[a]=V(i[a],e,t,r,a);e.pop(),t.pop()}else s=i;return s}var W=new x;W.tokenize=function(i){return i.slice()};W.join=W.removeEmpty=function(i){return i};function he(i,e){let t=0,r=0;return{annotated:ue(i,e).map(o=>{if(o.added){t+=1;let s=o.value,l=s.match(/^(\s*)/),a=l?l[0]:"",d=s.match(/(\s*)$/),f=d?d[0]:"",p=s;return f.length>0&&(p=p.substring(0,p.length-f.length)),a.length>0&&(p=p.substring(a.length)),p.length>0?`${a}<mark>${p}</mark>${f}`:`<mark>${s}</mark>`}return o.removed?(r+=1,""):o.value}).join(""),additions:t,removals:r}}var I=class extends S.Modal{originalText;rewrittenText;rewriteNote;onAcceptAll;showDiff;constructor(e,t,r,n,o=!0,s){super(e),this.originalText=t,this.rewrittenText=r,this.rewriteNote=s,this.onAcceptAll=n,this.showDiff=o}onOpen(){let{contentEl:e}=this;if(e.empty(),e.addClass("coffee-rewrite-modal"),e.createEl("h2",{text:"Review Rewrite"}),this.rewriteNote){let l=e.createDiv("note-container");l.createEl("h4",{text:"Note from the AI"}),l.createDiv("note-content").setText(this.rewriteNote)}let t=e.createDiv("text-container original-text-container");t.createEl("h4",{text:"Original"});let r=t.createDiv("modal-text-content");S.MarkdownRenderer.render(this.app,this.originalText,r,"",this);let n=e.createDiv("text-container rewritten-text-container"),o=this.showDiff?"Rewritten (changes highlighted)":"Rewritten Text";n.createEl("h4",{text:o});let s=n.createDiv("modal-text-content");if(this.showDiff){let a=he(this.originalText,this.rewrittenText).annotated;S.MarkdownRenderer.render(this.app,a,s,"",this)}else S.MarkdownRenderer.render(this.app,this.rewrittenText,s,"",this);new S.Setting(e).addButton(l=>l.setButtonText("Accept").setCta().onClick(()=>{this.onAcceptAll(this.rewrittenText),this.close()})).addButton(l=>l.setButtonText("Cancel").onClick(()=>{this.close()}))}onClose(){let{contentEl:e}=this;e.empty()}};async function Y(i,e){let t=e.getSelection(),r=!!t,n=t||e.getLine(e.getCursor().line),o=e.getCursor().line,s=r?null:e.getLine(o);if(!n.trim()){E("Coffee Rewriter: Nothing to rewrite.");return}E("\u2615\uFE0F Calling LLM to rewrite text...");let l=await U(i.cfg,n);if(!l){E("Coffee Rewriter: Rewrite request failed or returned empty.");return}let a=l.rewrittenText.trim(),d=l.note;if(a===n.trim()){E("\u2705 Text looks good, nothing to change.");return}let f=a;if(i.cfg.preserveQuotes){let m=n.match(/"([^"]+)"/g)||[],v=f.match(/"([^"]+)"/g)||[];if(m.length===v.length){let c=f;for(let y=0;y<m.length;y++)c=c.replace(v[y],m[y]);f=c}}let p=m=>{r?e.replaceSelection(m):s!==null&&e.replaceRange(m,{line:o,ch:0},{line:o,ch:s.length}),E("\u2615\uFE0F Rewrite accepted!")};new I(i.app,n,f,p,!0,d).open()}var h=require("obsidian");var H=class extends h.Modal{selectedText;plugin;editor;promptTextArea;promptSelect;customPromptContainer;chosenPromptTemplate=null;CUSTOM_PROMPT_ID="__custom__";promptPreviewArea;textToRewrite;constructor(e,t,r,n){super(e),this.selectedText=t,this.plugin=r,this.editor=n,this.textToRewrite=t}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("coffee-tailored-prompt-modal"),e.createEl("h2",{text:"Tailored Rewrite"});let t=e.createDiv("text-container original-text-container text-to-rewrite-container");new h.Setting(t).setName("Text to Rewrite:").setHeading().settingEl.addClass("coffee-text-to-rewrite-label");let r=t.createDiv("modal-text-content");h.MarkdownRenderer.render(this.app,this.textToRewrite,r,"",this);let n=new h.Setting(e).setName("Prompt Template");this.promptPreviewArea=e.createDiv(),this.promptPreviewArea.addClass("coffee-tailored-prompt-preview"),this.promptPreviewArea.style.display="none",this.customPromptContainer=e.createDiv("custom-prompt-container-div"),this.customPromptContainer.addClass("coffee-tailored-custom-prompt-container"),this.customPromptContainer.style.display="none",n.addDropdown(s=>{this.promptSelect=s,this.plugin.cfg.promptTemplates.forEach(a=>{s.addOption(a.id,a.name)}),s.addOption(this.CUSTOM_PROMPT_ID,"-- Write a new custom prompt --");let l=!0;this.plugin.cfg.promptTemplates.length>0?(s.setValue(this.plugin.cfg.promptTemplates[0].id),this.chosenPromptTemplate=this.plugin.cfg.promptTemplates[0],l=!1):s.setValue(this.CUSTOM_PROMPT_ID),this.toggleCustomPromptUI(l),this.updatePromptPreview(s.getValue()),s.onChange(a=>{let d=a===this.CUSTOM_PROMPT_ID;d?this.chosenPromptTemplate=null:this.chosenPromptTemplate=this.plugin.cfg.promptTemplates.find(f=>f.id===a)||null,this.toggleCustomPromptUI(d),this.updatePromptPreview(a)})}),new h.Setting(this.customPromptContainer).setName("Custom Prompt").setDesc("Enter your custom prompt. The selected text will be appended to this.").addTextArea(s=>{this.promptTextArea=s,s.inputEl.rows=5,s.inputEl.cols=50,s.setPlaceholder("Example: Summarize this text for a 5-year-old."),s.inputEl.addClass("coffee-tailored-prompt-textarea")}),new h.Setting(e).addButton(s=>s.setButtonText("Rewrite with this prompt").setCta().onClick(()=>{let l="";if(this.chosenPromptTemplate)l=this.chosenPromptTemplate.prompt;else if(this.promptTextArea.getValue().trim())l=this.promptTextArea.getValue().trim();else{new h.Notice("Please select a template or enter a custom prompt.");return}this.close(),this.handleRewrite(l)}))}toggleCustomPromptUI(e){this.customPromptContainer&&this.promptPreviewArea&&(e?(this.customPromptContainer.style.display="block",this.promptPreviewArea.style.display="none"):(this.customPromptContainer.style.display="none",this.promptPreviewArea.style.display="block"))}updatePromptPreview(e){if(this.promptPreviewArea)if(e&&e!==this.CUSTOM_PROMPT_ID){let t=this.plugin.cfg.promptTemplates.find(r=>r.id===e);t?this.promptPreviewArea.textContent=t.prompt:this.promptPreviewArea.textContent="Prompt not found."}else this.promptPreviewArea.textContent=""}async handleRewrite(e){new h.Notice("\u2615\uFE0F Calling LLM with tailored prompt...");let t=await U(this.plugin.cfg,this.selectedText,e);if(!t){new h.Notice("Coffee Rewriter: Tailored rewrite request failed or returned empty.");return}let r=t.rewrittenText,n=t.note,o=r.trim();if(o===this.selectedText.trim()){new h.Notice("\u2705 Text looks good, tailored prompt resulted in no changes.");return}let s=l=>{if(this.editor.getSelection()===this.selectedText)this.editor.replaceSelection(l);else{let d=this.editor.listSelections()[0];if(d)this.editor.replaceRange(l,d.anchor,d.head);else{new h.Notice("Could not apply rewrite: editor selection changed.");return}}new h.Notice("\u2615\uFE0F Tailored rewrite accepted!")};new I(this.app,this.selectedText,o,s,!1,n).open()}onClose(){let{contentEl:e}=this;e.empty()}};var z=class extends q.Plugin{settings=B;async onload(){await this.loadSettings(),this.addSettingTab(new j(this.app,this)),this.addCommand({id:"coffee-quick-rewrite",name:"Quick Rewrite (Paragraph / Selection)",editorCallback:e=>Y(this,e),icon:"bot"}),this.addCommand({id:"coffee-tailored-rewrite",name:"Tailored rewrite",editorCallback:e=>{let t=e.getSelection()||e.getLine(e.getCursor().line);if(!t.trim()){new q.Notice("Nothing selected to rewrite.");return}new H(this.app,t,this,e).open()},icon:"edit"}),this.registerEvent(this.app.workspace.on("editor-menu",(e,t)=>{e.addItem(r=>{r.setTitle("Quick Rewrite (Paragraph / Selection)").setIcon("bot").onClick(()=>Y(this,t))}),e.addItem(r=>{r.setTitle("Tailored rewrite").setIcon("bot").onClick(()=>{let n=t.getSelection()||t.getLine(t.getCursor().line);if(!n.trim()){new q.Notice("Nothing selected to rewrite.");return}new H(this.app,n,this,t).open()})})})),console.info("Coffee Rewriter loaded \u2615\uFE0F")}onunload(){console.info("Coffee Rewriter unloaded \u2615\uFE0F")}async loadSettings(){this.settings=Object.assign({},B,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}get cfg(){return this.settings}};
