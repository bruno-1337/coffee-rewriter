/* THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the GitHub repository of this plugin. */

"use strict";var W=Object.defineProperty;var Te=Object.getOwnPropertyDescriptor;var ye=Object.getOwnPropertyNames;var Ce=Object.prototype.hasOwnProperty;var xe=(i,e)=>{for(var t in e)W(i,t,{get:e[t],enumerable:!0})},Se=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ye(e))!Ce.call(i,n)&&n!==t&&W(i,n,{get:()=>e[n],enumerable:!(r=Te(e,n))||r.enumerable});return i};var Re=i=>Se(W({},"__esModule",{value:!0}),i);var Ie={};xe(Ie,{default:()=>G});module.exports=Re(Ie);var $=require("obsidian");var T=require("obsidian");var E=require("obsidian");async function ne(i,e,t){let{openAiKey:r,openAiModel:n}=i;if(!r){new E.Notice("Coffee Rewriter: OpenAI key missing. Add it in the settings.");return}try{return(await(0,E.requestUrl)({url:"https://api.openai.com/v1/chat/completions",method:"POST",contentType:"application/json",headers:{Authorization:`Bearer ${r}`},body:JSON.stringify({model:n,messages:[{role:"system",content:t},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content}catch(o){console.error("Coffee Rewriter \u2013 OpenAI error",o),new E.Notice("Coffee Rewriter: OpenAI request failed (see console).");return}}async function ie(i){let{openAiKey:e}=i;if(!e)return[];try{let r=(await(0,E.requestUrl)({url:"https://api.openai.com/v1/models",method:"GET",headers:{Authorization:`Bearer ${e}`}})).json;return r&&Array.isArray(r.data)?r.data.map(n=>n.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 OpenAI models error",t),[]}}var b=require("obsidian");async function re(i,e,t){let{geminiKey:r,geminiModel:n}=i;if(!r){new b.Notice("Coffee Rewriter: Gemini API key missing.");return}try{let o=`https://generativelanguage.googleapis.com/v1beta/models/${n}:generateContent?key=${r}`;return(await(0,b.requestUrl)({url:o,method:"POST",contentType:"application/json",body:JSON.stringify({contents:[{role:"user",parts:[{text:`${t}

${e}`}]}]})})).json?.candidates?.[0]?.content?.parts?.[0]?.text}catch(o){console.error("Coffee Rewriter \u2013 Gemini error",o),new b.Notice("Coffee Rewriter: Gemini request failed (see console).");return}}async function oe(i){let{geminiKey:e}=i;if(!e)return[];try{let r=(await(0,b.requestUrl)({url:`https://generativelanguage.googleapis.com/v1beta/models?key=${e}`,method:"GET"})).json;return r&&Array.isArray(r.models)?r.models.map(n=>n.name).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 Gemini models error",t),[]}}var k=require("obsidian");function j(i){return i.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}async function se(i,e,t){let{lmstudioEndpoint:r,lmStudioModel:n,stripReasoning:o}=i;try{let l=(await(0,k.requestUrl)({url:`${r}/v1/chat/completions`,method:"POST",contentType:"application/json",body:JSON.stringify({model:n,messages:[{role:"system",content:t},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content;return l&&(o?j(l):l)}catch(s){console.error("Coffee Rewriter \u2013 LM Studio error",s),new k.Notice("Coffee Rewriter: Could not reach LM Studio server.");return}}async function le(i){let{lmstudioEndpoint:e}=i;try{let r=(await(0,k.requestUrl)({url:`${e}/v1/models`,method:"GET",contentType:"application/json"})).json;return r&&Array.isArray(r.data)?r.data.map(n=>n.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 LM Studio models",t),[]}}var M=require("obsidian");async function ae(i,e,t){let{claudeKey:r,claudeModel:n}=i;if(!r){new M.Notice("Coffee Rewriter: Claude API key missing. Add it in the settings.");return}try{let s=(await(0,M.requestUrl)({url:"https://api.anthropic.com/v1/messages",method:"POST",contentType:"application/json",headers:{"x-api-key":r,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:n,max_tokens:2048,system:t,messages:[{role:"user",content:e}]})})).json?.content?.[0];return s&&s.type==="text"?s.text:void 0}catch(o){console.error("Coffee Rewriter \u2013 Claude error",o),new M.Notice("Coffee Rewriter: Claude request failed (see console).");return}}async function pe(i){let{claudeKey:e}=i;if(!e)return[];try{let r=(await(0,M.requestUrl)({url:"https://api.anthropic.com/v1/models",method:"GET",contentType:"application/json",headers:{"x-api-key":e,"anthropic-version":"2023-06-01"}})).json;return r&&Array.isArray(r.data)?r.data.map(n=>n.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 Claude models error",t),[]}}var H=require("obsidian");async function de(i,e,t){let{ollamaEndpoint:r,ollamaModel:n,stripReasoning:o}=i;try{let l=(await(0,H.requestUrl)({url:`${r}/v1/chat/completions`,method:"POST",contentType:"application/json",body:JSON.stringify({model:n,messages:[{role:"system",content:t},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content;return l&&(o?j(l):l)}catch(s){console.error("Coffee Rewriter \u2013 Ollama error",s),new H.Notice("Coffee Rewriter: Could not reach Ollama server.");return}}async function ce(i){let{ollamaEndpoint:e}=i;try{let r=(await(0,H.requestUrl)({url:`${e}/v1/models`,method:"GET",contentType:"application/json"})).json;return r&&Array.isArray(r.data)?r.data.map(n=>n.id).filter(Boolean):[]}catch(t){return console.error("Coffee Rewriter \u2013 Ollama models",t),[]}}var C=require("obsidian"),B=class extends C.Modal{plugin;template;isNew;onSave;nameInput;promptInput;constructor(e,t,r,n){super(e),this.plugin=t,this.onSave=n,r?(this.isNew=!1,this.template={...r}):(this.isNew=!0,this.template={id:`custom-${new Date().getTime()}`,name:"",prompt:""})}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("coffee-prompt-edit-modal"),e.createEl("h2",{text:this.isNew?"Add New Prompt Template":"Edit Prompt Template"});let t=!this.isNew&&this.plugin.cfg.promptTemplates.length>0&&this.plugin.cfg.promptTemplates[0].id===this.template.id;t||new C.Setting(e).setName("Template Name").addText(r=>{this.nameInput=r,r.setValue(this.template.name).setPlaceholder("Enter template name (e.g., Summarize for Twitter)")}),new C.Setting(e).setName("Prompt Content"),this.promptInput=new C.TextAreaComponent(e).setValue(this.template.prompt).setPlaceholder("Enter the full prompt here. The selected text will be appended when used."),this.promptInput.inputEl.rows=8,this.promptInput.inputEl.addClass("coffee-settings-prompt-textarea"),this.promptInput.inputEl.style.width="100%",this.promptInput.inputEl.style.marginTop="var(--size-2-2)",new C.Setting(e).addButton(r=>r.setButtonText("Save").setCta().onClick(()=>{if(this.nameInput&&(this.template.name=this.nameInput.getValue().trim()),this.template.prompt=this.promptInput.getValue().trim(),!this.template.name&&!t){new C.Notice("Template name cannot be empty.");return}else t&&(this.template.name=this.plugin.cfg.promptTemplates[0].name);if(!this.template.prompt){new C.Notice("Prompt content cannot be empty.");return}this.onSave({action:"save",template:this.template}),this.close()})).addButton(r=>r.setButtonText("Cancel").onClick(()=>{this.close()}))}onClose(){let{contentEl:e}=this;e.empty()}};var K={provider:"openai",openAiKey:"",openAiModel:"gpt-3.5-turbo",geminiKey:"",geminiModel:"gemini-pro",lmstudioEndpoint:"http://localhost:1234",lmStudioModel:"",promptTemplates:[{id:"default-quick-rewrite",name:"Quick Rewrite",prompt:"Improve clarity, grammar, and conciseness of the following text."},{id:"pirate-speak",name:"Pirate Speak",prompt:"Rewrite the following text as if you were a swashbuckling pirate, arrr! Keep the core meaning but infuse it with pirate slang and bravado."},{id:"professional-tone",name:"Professional Tone",prompt:"Please rewrite the following text in a more professional and formal tone. Ensure clarity, conciseness, and appropriate business language. Avoid jargon where possible, or explain it if necessary."},{id:"academic-phd-style",name:"Academic (PhD Style)",prompt:"Please revise the following text to reflect the style, depth, and rigor of a PhD-level academic paper. Focus on sophisticated vocabulary, nuanced argumentation, formal scholarly tone, and logical precision."}],preserveQuotes:!1,stripReasoning:!1,claudeKey:"",claudeModel:"claude-3-haiku-20240307",ollamaEndpoint:"http://localhost:11434",ollamaModel:""},U=class extends T.PluginSettingTab{plugin;selectedTemplateIdForEditing=null;promptTemplateSettingsContainer;constructor(e,t){super(e,t),this.plugin=t,this.plugin.cfg.promptTemplates&&this.plugin.cfg.promptTemplates.length>0&&(this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id)}addTextSetting(e,t,r,n,o,s=!1){new T.Setting(e).setName(t).setDesc(r).addText(l=>{s&&(l.inputEl.type="password"),l.setValue(n()).onChange(async a=>{o(a.trim()),await this.plugin.saveSettings()})})}async addModelDropdownSetting(e,t,r,n,o,s){let l=new T.Setting(e).setName(t).setDesc(r),a=null,d=null,f=async p=>{if(!a)return;let m=!1,u="API Key",c="";switch(n){case"openai":m=!!this.plugin.cfg.openAiKey,u="API Key",c="OpenAI API Key";break;case"gemini":m=!!this.plugin.cfg.geminiKey,u="API Key",c="Gemini API Key";break;case"claude":m=!!this.plugin.cfg.claudeKey,u="API Key",c="Claude API Key";break;case"lmstudio":m=!!this.plugin.cfg.lmstudioEndpoint,u="Server URL",c="LM Studio Server URL";break;case"ollama":m=!!this.plugin.cfg.ollamaEndpoint,u="Server URL",c="Ollama Server URL";break;default:a.selectEl.options.length=0,a.addOption("","--Provider error--"),a.setValue(""),a.selectEl.disabled=!0,d&&d.setDisabled(!0),l.setDesc(r+" (Unknown provider configuration)");return}let g=`--Set ${u} First--`,x=`Set ${c} to load models`;if(!m){a.selectEl.options.length=0,a.addOption("",g),a.setValue(""),a.selectEl.disabled=!0,d&&d.setDisabled(!0),l.setDesc(r+` (${x})`);return}a.selectEl.disabled=!0,d&&d.setDisabled(!0),l.setDesc(r+(p?" (Refreshing models...)":" (Loading models...)"));let h=[];try{switch(n){case"openai":h=await ie(this.plugin.cfg);break;case"gemini":h=await oe(this.plugin.cfg),h=h.map(y=>y.startsWith("models/")?y.split("/")[1]:y);break;case"claude":h=await pe(this.plugin.cfg);break;case"lmstudio":h=await le(this.plugin.cfg);break;case"ollama":h=await ce(this.plugin.cfg);break}}catch(y){new T.Notice(`Failed to load models for ${n}. Check console.`),console.error(`Coffee Rewriter - Error loading models for ${n}:`,y)}l.setDesc(r),a.selectEl.disabled=!1,d&&d.setDisabled(!1),a.selectEl.options.length=0,h.length===0?a.addOption("","--No models found or loaded--"):(a.addOption("","--Select Model--"),h.forEach(y=>{a&&a.addOption(y,y)})),a.setValue(o())};l.addDropdown(async p=>{a=p,p.selectEl.options.length=0,p.addOption("","--Select Model--"),p.setValue(o()),p.onChange(async m=>{s(m),await this.plugin.saveSettings()}),await f(!1)}),l.addButton(p=>{d=p,p.setIcon("refresh-cw").setTooltip("Refresh model list").onClick(async()=>{await f(!0)})})}renderPromptTemplateEditor(){this.promptTemplateSettingsContainer.empty(),(!this.plugin.cfg.promptTemplates||this.plugin.cfg.promptTemplates.length===0)&&(this.plugin.cfg.promptTemplates=K.promptTemplates.map(n=>({...n})),this.plugin.saveSettings(),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates.length>0?this.plugin.cfg.promptTemplates[0].id:null),!this.selectedTemplateIdForEditing&&this.plugin.cfg.promptTemplates.length>0?this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id:this.plugin.cfg.promptTemplates.length===0&&(this.selectedTemplateIdForEditing=null);let e=new T.Setting(this.promptTemplateSettingsContainer).setName("Manage Templates");e.addButton(n=>n.setIcon("plus").setTooltip("Add new prompt template").setCta().onClick(()=>{new B(this.app,this.plugin,null,this.handlePromptSaveAction.bind(this)).open()})),e.addDropdown(n=>{this.plugin.cfg.promptTemplates.length===0?(n.addOption("__none__","-- No templates defined --"),n.setDisabled(!0)):this.plugin.cfg.promptTemplates.forEach(o=>{n.addOption(o.id,o.name)}),this.selectedTemplateIdForEditing?n.setValue(this.selectedTemplateIdForEditing):this.plugin.cfg.promptTemplates.length>0&&(n.setValue(this.plugin.cfg.promptTemplates[0].id),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id),n.onChange(async o=>{this.selectedTemplateIdForEditing=o,this.renderPromptTemplateEditor()})}),e.addButton(n=>n.setIcon("pencil").setTooltip("Edit selected prompt template").onClick(()=>{let o=this.plugin.cfg.promptTemplates.find(s=>s.id===this.selectedTemplateIdForEditing);o?new B(this.app,this.plugin,o,this.handlePromptSaveAction.bind(this)).open():new T.Notice("No template selected to edit. Please add one first if the list is empty.")}));let t=this.plugin.cfg.promptTemplates.find(n=>n.id===this.selectedTemplateIdForEditing),r=t?this.plugin.cfg.promptTemplates.indexOf(t)===0:!1;if(t&&!r&&e.addButton(n=>n.setIcon("trash").setTooltip("Delete selected prompt template").setWarning().onClick(async()=>{let o=this.plugin.cfg.promptTemplates.findIndex(s=>s.id===this.selectedTemplateIdForEditing);o>0?(this.plugin.cfg.promptTemplates.splice(o,1),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id,await this.plugin.saveSettings(),this.renderPromptTemplateEditor()):new T.Notice("Cannot delete this template.")})),t){new T.Setting(this.promptTemplateSettingsContainer).setName("Selected Prompt Content").setDesc("Content of the template selected above. Click the pencil icon to edit.");let n=this.promptTemplateSettingsContainer.createDiv({cls:"coffee-prompt-display-box"});n.setText(t.prompt),n.style.width="100%",n.style.padding="var(--size-2-3)",n.style.border="1px solid var(--background-modifier-border)",n.style.borderRadius="var(--radius-m)",n.style.backgroundColor="var(--background-secondary)",n.style.whiteSpace="pre-wrap",n.style.wordBreak="break-word",n.style.maxHeight="150px",n.style.overflowY="auto",n.style.marginTop="var(--size-2-2)",n.style.marginBottom="var(--size-4-4)"}else this.plugin.cfg.promptTemplates.length>0&&this.selectedTemplateIdForEditing&&new T.Setting(this.promptTemplateSettingsContainer).setName("Error").setDesc("Could not display selected prompt. Please try selecting again.")}async handlePromptSaveAction(e){let t=!1,r=this.selectedTemplateIdForEditing;if(e.action==="save"){let{template:n}=e,o=this.plugin.cfg.promptTemplates.findIndex(s=>s.id===n.id);o>-1?this.plugin.cfg.promptTemplates[o]=n:(this.plugin.cfg.promptTemplates.push(n),r=n.id),t=!0}t&&(this.selectedTemplateIdForEditing=r,await this.plugin.saveSettings(),this.renderPromptTemplateEditor())}display(){let{containerEl:e}=this;e.empty(),e.createEl("h3",{text:"LLM Provider Settings"}),new T.Setting(e).setName("LLM Provider").setDesc("Choose which backend to use for rewriting.").addDropdown(n=>{n.addOption("openai","OpenAI"),n.addOption("gemini","Gemini"),n.addOption("lmstudio","LM Studio"),n.addOption("claude","Claude (Anthropic)"),n.addOption("ollama","Ollama"),n.setValue(this.plugin.cfg.provider).onChange(async o=>{this.plugin.cfg.provider=o,await this.plugin.saveSettings(),this.display()})});let t=this.plugin.cfg.provider;t==="openai"?(this.addTextSetting(e,"API Key","Your OpenAI secret key.",()=>this.plugin.cfg.openAiKey,n=>this.plugin.cfg.openAiKey=n,!0),this.addModelDropdownSetting(e,"Model","OpenAI model.","openai",()=>this.plugin.cfg.openAiModel,n=>this.plugin.cfg.openAiModel=n)):t==="gemini"?(this.addTextSetting(e,"API Key","Google AI API key.",()=>this.plugin.cfg.geminiKey,n=>this.plugin.cfg.geminiKey=n,!0),this.addModelDropdownSetting(e,"Model","Gemini model.","gemini",()=>this.plugin.cfg.geminiModel,n=>this.plugin.cfg.geminiModel=n)):t==="lmstudio"?(this.addTextSetting(e,"Server URL","LM Studio endpoint (http://host:port)",()=>this.plugin.cfg.lmstudioEndpoint,n=>this.plugin.cfg.lmstudioEndpoint=n),this.addModelDropdownSetting(e,"Model","LM Studio model (requires server to be running).","lmstudio",()=>this.plugin.cfg.lmStudioModel,n=>this.plugin.cfg.lmStudioModel=n)):t==="claude"?(this.addTextSetting(e,"API Key","Your Anthropic Claude API key.",()=>this.plugin.cfg.claudeKey,n=>this.plugin.cfg.claudeKey=n,!0),this.addModelDropdownSetting(e,"Model","Claude model.","claude",()=>this.plugin.cfg.claudeModel,n=>this.plugin.cfg.claudeModel=n)):t==="ollama"&&(this.addTextSetting(e,"Server URL","Ollama endpoint (http://host:port)",()=>this.plugin.cfg.ollamaEndpoint,n=>this.plugin.cfg.ollamaEndpoint=n),this.addModelDropdownSetting(e,"Model","Ollama model (requires server to be running).","ollama",()=>this.plugin.cfg.ollamaModel,n=>this.plugin.cfg.ollamaModel=n)),e.createEl("h3",{text:"Prompts"}),this.promptTemplateSettingsContainer=e.createDiv("prompt-templates-settings-area"),this.renderPromptTemplateEditor(),e.createEl("h3",{text:"Other Settings"}),new T.Setting(e).setName("Preserve text inside quotes").setDesc('Do not rewrite text that is wrapped in "double quotes".').addToggle(n=>n.setValue(this.plugin.cfg.preserveQuotes).onChange(async o=>{this.plugin.cfg.preserveQuotes=o,await this.plugin.saveSettings()})),(t==="lmstudio"||t==="ollama")&&new T.Setting(e).setName("Strip <think> reasoning (local models)").setDesc("If your local model emits <think>...</think> blocks, strip them from the final output.").addToggle(n=>n.setValue(this.plugin.cfg.stripReasoning).onChange(async o=>{this.plugin.cfg.stripReasoning=o,await this.plugin.saveSettings()}))}};function Pe(i){return`${i.trim()} Reply with ONLY ONE JSON object containing two fields: "rewrittenText" (containing the entire improved version as a single string, including any lists or paragraphs) and "note" (containing a brief note about what was changed). Always return a single, valid JSON object. Do not return a list of JSON objects.`}function Le(i){if(i)try{let e=i.match(/\{[\s\S]*\}/);if(e){let t=e[0],r=JSON.parse(t);if(typeof r.rewrittenText=="string"&&typeof r.note=="string")return r}return{rewrittenText:i.trim(),note:"The AI didn't provide structured feedback for this rewrite."}}catch(e){return console.warn("Coffee Rewriter - Failed to parse LLM response as JSON:",e),{rewrittenText:i.trim(),note:"The AI didn't provide structured feedback for this rewrite."}}}async function z(i,e,t){let r;t!==void 0?r=t:i.promptTemplates&&i.promptTemplates.length>0&&i.promptTemplates[0]&&typeof i.promptTemplates[0].prompt=="string"?r=i.promptTemplates[0].prompt:(console.warn("Coffee Rewriter: Default prompt template not found or invalid. Using a fallback prompt."),r="Improve the following text.");let n=Pe(r),o;switch(i.provider){case"openai":o=await ne(i,e,n);break;case"gemini":o=await re(i,e,n);break;case"lmstudio":o=await se(i,e,n);break;case"claude":o=await ae(i,e,n);break;case"ollama":o=await de(i,e,n);break;default:console.warn(`Coffee Rewriter: Unknown provider: ${i.provider}`);return}return Le(o)}var me=require("obsidian"),fe;function O(i,e=4e3){fe?.hide(),fe=new me.Notice(i,e)}var R=require("obsidian");function S(){}S.prototype={diff:function(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=n.callback;typeof n=="function"&&(o=n,n={}),this.options=n;var s=this;function l(w){return o?(setTimeout(function(){o(void 0,w)},0),!0):w}e=this.castInput(e),t=this.castInput(t),e=this.removeEmpty(this.tokenize(e)),t=this.removeEmpty(this.tokenize(t));var a=t.length,d=e.length,f=1,p=a+d;n.maxEditLength&&(p=Math.min(p,n.maxEditLength));var m=(r=n.timeout)!==null&&r!==void 0?r:1/0,u=Date.now()+m,c=[{oldPos:-1,lastComponent:void 0}],g=this.extractCommon(c[0],t,e,0);if(c[0].oldPos+1>=d&&g+1>=a)return l([{value:this.join(t),count:t.length}]);var x=-1/0,h=1/0;function y(){for(var w=Math.max(x,-f);w<=Math.min(h,f);w+=2){var P=void 0,N=c[w-1],F=c[w+1];N&&(c[w-1]=void 0);var J=!1;if(F){var ee=F.oldPos-w;J=F&&0<=ee&&ee<a}var te=N&&N.oldPos+1<d;if(!J&&!te){c[w]=void 0;continue}if(!te||J&&N.oldPos+1<F.oldPos?P=s.addToPath(F,!0,void 0,0):P=s.addToPath(N,void 0,!0,1),g=s.extractCommon(P,t,e,w),P.oldPos+1>=d&&g+1>=a)return l(Ae(s,P.lastComponent,t,e,s.useLongestToken));c[w]=P,P.oldPos+1>=d&&(h=Math.min(h,w-1)),g+1>=a&&(x=Math.max(x,w+1))}f++}if(o)(function w(){setTimeout(function(){if(f>p||Date.now()>u)return o();y()||w()},0)})();else for(;f<=p&&Date.now()<=u;){var _=y();if(_)return _}},addToPath:function(e,t,r,n){var o=e.lastComponent;return o&&o.added===t&&o.removed===r?{oldPos:e.oldPos+n,lastComponent:{count:o.count+1,added:t,removed:r,previousComponent:o.previousComponent}}:{oldPos:e.oldPos+n,lastComponent:{count:1,added:t,removed:r,previousComponent:o}}},extractCommon:function(e,t,r,n){for(var o=t.length,s=r.length,l=e.oldPos,a=l-n,d=0;a+1<o&&l+1<s&&this.equals(t[a+1],r[l+1]);)a++,l++,d++;return d&&(e.lastComponent={count:d,previousComponent:e.lastComponent}),e.oldPos=l,a},equals:function(e,t){return this.options.comparator?this.options.comparator(e,t):e===t||this.options.ignoreCase&&e.toLowerCase()===t.toLowerCase()},removeEmpty:function(e){for(var t=[],r=0;r<e.length;r++)e[r]&&t.push(e[r]);return t},castInput:function(e){return e},tokenize:function(e){return e.split("")},join:function(e){return e.join("")}};function Ae(i,e,t,r,n){for(var o=[],s;e;)o.push(e),s=e.previousComponent,delete e.previousComponent,e=s;o.reverse();for(var l=0,a=o.length,d=0,f=0;l<a;l++){var p=o[l];if(p.removed){if(p.value=i.join(r.slice(f,f+p.count)),f+=p.count,l&&o[l-1].added){var u=o[l-1];o[l-1]=o[l],o[l]=u}}else{if(!p.added&&n){var m=t.slice(d,d+p.count);m=m.map(function(g,x){var h=r[f+x];return h.length>g.length?h:g}),p.value=i.join(m)}else p.value=i.join(t.slice(d,d+p.count));d+=p.count,p.added||(f+=p.count)}}var c=o[a-1];return a>1&&typeof c.value=="string"&&(c.added||c.removed)&&i.equals("",c.value)&&(o[a-2].value+=c.value,o.pop()),o}var ct=new S;function Ee(i,e){if(typeof i=="function")e.callback=i;else if(i)for(var t in i)i.hasOwnProperty(t)&&(e[t]=i[t]);return e}var ue=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,ge=/\S/,X=new S;X.equals=function(i,e){return this.options.ignoreCase&&(i=i.toLowerCase(),e=e.toLowerCase()),i===e||this.options.ignoreWhitespace&&!ge.test(i)&&!ge.test(e)};X.tokenize=function(i){for(var e=i.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),t=0;t<e.length-1;t++)!e[t+1]&&e[t+2]&&ue.test(e[t])&&ue.test(e[t+2])&&(e[t]+=e[t+2],e.splice(t+1,2),t--);return e};function he(i,e,t){return t=Ee(t,{ignoreWhitespace:!0}),X.diff(i,e,t)}var we=new S;we.tokenize=function(i){this.options.stripTrailingCr&&(i=i.replace(/\r\n/g,`
`));var e=[],t=i.split(/(\n|\r\n)/);t[t.length-1]||t.pop();for(var r=0;r<t.length;r++){var n=t[r];r%2&&!this.options.newlineIsToken?e[e.length-1]+=n:(this.options.ignoreWhitespace&&(n=n.trim()),e.push(n))}return e};var be=new S;be.tokenize=function(i){return i.split(/(\S.+?[.!?])(?=\s+|$)/)};var Me=new S;Me.tokenize=function(i){return i.split(/([{}:;,]|\s+)/)};function V(i){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?V=function(e){return typeof e}:V=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},V(i)}var Oe=Object.prototype.toString,q=new S;q.useLongestToken=!0;q.tokenize=we.tokenize;q.castInput=function(i){var e=this.options,t=e.undefinedReplacement,r=e.stringifyReplacer,n=r===void 0?function(o,s){return typeof s>"u"?t:s}:r;return typeof i=="string"?i:JSON.stringify(Q(i,null,null,n),n,"  ")};q.equals=function(i,e){return S.prototype.equals.call(q,i.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"))};function Q(i,e,t,r,n){e=e||[],t=t||[],r&&(i=r(n,i));var o;for(o=0;o<e.length;o+=1)if(e[o]===i)return t[o];var s;if(Oe.call(i)==="[object Array]"){for(e.push(i),s=new Array(i.length),t.push(s),o=0;o<i.length;o+=1)s[o]=Q(i[o],e,t,r,n);return e.pop(),t.pop(),s}if(i&&i.toJSON&&(i=i.toJSON()),V(i)==="object"&&i!==null){e.push(i),s={},t.push(s);var l=[],a;for(a in i)i.hasOwnProperty(a)&&l.push(a);for(l.sort(),o=0;o<l.length;o+=1)a=l[o],s[a]=Q(i[a],e,t,r,a);e.pop(),t.pop()}else s=i;return s}var Y=new S;Y.tokenize=function(i){return i.slice()};Y.join=Y.removeEmpty=function(i){return i};function ve(i,e){let t=0,r=0;return{annotated:he(i,e).map(o=>{if(o.added){t+=1;let s=o.value,l=s.match(/^(\s*)/),a=l?l[0]:"",d=s.match(/(\s*)$/),f=d?d[0]:"",p=s;return f.length>0&&(p=p.substring(0,p.length-f.length)),a.length>0&&(p=p.substring(a.length)),p.length>0?`${a}<mark>${p}</mark>${f}`:`<mark>${s}</mark>`}return o.removed?(r+=1,""):o.value}).join(""),additions:t,removals:r}}var I=class extends R.Modal{originalText;rewrittenText;rewriteNote;onAcceptAll;showDiff;onRetry;rewrittenContentDiv;constructor(e,t,r,n,o=!1,s,l){super(e),this.originalText=t,this.rewrittenText=r,this.rewriteNote=s,this.onAcceptAll=n,this.showDiff=o,this.onRetry=l}onOpen(){let{contentEl:e}=this;if(e.empty(),e.addClass("coffee-rewrite-modal"),e.createEl("h2",{text:"Review Rewrite"}),this.rewriteNote){let l=e.createDiv("note-container");l.createEl("h4",{text:"Note from the AI"}),l.createDiv("note-content").setText(this.rewriteNote)}let t=e.createDiv("text-container original-text-container");t.createEl("h4",{text:"Original"});let r=t.createDiv("modal-text-content");R.MarkdownRenderer.render(this.app,this.originalText,r,"",this);let n=e.createDiv("text-container rewritten-text-container");n.createEl("h4",{text:"Rewritten Text"}),this.rewrittenContentDiv=n.createDiv("modal-text-content"),this.updateRewrittenText(),new R.Setting(e).setName("Show changes highlighted").setDesc("Toggle to highlight the differences between original and rewritten text").addToggle(l=>{l.setValue(this.showDiff),l.onChange(a=>{this.showDiff=a,this.updateRewrittenText()})}).settingEl.addClass("diff-toggle");let s=new R.Setting(e).addButton(l=>l.setButtonText("Accept").setCta().onClick(()=>{this.onAcceptAll(this.rewrittenText),this.close()}));this.onRetry&&s.addButton(l=>l.setButtonText("Try again with a different prompt").onClick(()=>{this.close(),this.onRetry()})),s.addButton(l=>l.setButtonText("Cancel").onClick(()=>{this.close()}))}updateRewrittenText(){if(this.rewrittenContentDiv)if(this.rewrittenContentDiv.empty(),this.showDiff){let t=ve(this.originalText,this.rewrittenText).annotated;R.MarkdownRenderer.render(this.app,t,this.rewrittenContentDiv,"",this)}else R.MarkdownRenderer.render(this.app,this.rewrittenText,this.rewrittenContentDiv,"",this)}onClose(){let{contentEl:e}=this;e.empty()}};var v=require("obsidian");var L=require("obsidian"),D=class extends L.Modal{originalText;rewrittenText;onSelect;selectedPane=null;originalContainer;rewrittenContainer;selectButton;constructor(e,t,r,n){super(e),this.originalText=t,this.rewrittenText=r,this.onSelect=n}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("coffee-choose-text-modal"),e.createEl("h2",{text:"Use Original or Rewritten Text?"}),this.originalContainer=e.createDiv("text-container original-text-container"),this.originalContainer.createEl("h4",{text:"Original Text"});let t=this.originalContainer.createDiv("modal-text-content");L.MarkdownRenderer.render(this.app,this.originalText,t,"",this),this.originalContainer.onClickEvent(()=>this.selectPane("original")),this.rewrittenContainer=e.createDiv("text-container rewritten-text-container"),this.rewrittenContainer.createEl("h4",{text:"Rewritten Text"});let r=this.rewrittenContainer.createDiv("modal-text-content");L.MarkdownRenderer.render(this.app,this.rewrittenText,r,"",this),this.rewrittenContainer.onClickEvent(()=>this.selectPane("rewritten")),new L.Setting(e).addButton(n=>this.selectButton=n.setButtonText("Select this text").setCta().setDisabled(!0).onClick(()=>{if(this.selectedPane){let o=this.selectedPane==="original"?this.originalText:this.rewrittenText;this.onSelect(o),this.close()}}))}selectPane(e){this.selectedPane=e,this.originalContainer.removeClass("selected"),this.rewrittenContainer.removeClass("selected"),e==="original"?this.originalContainer.addClass("selected"):this.rewrittenContainer.addClass("selected"),this.selectButton.setDisabled(!1)}onClose(){let{contentEl:e}=this;e.empty()}};var A=class i extends v.Modal{selectedText;plugin;editor;promptTextArea;promptSelect;customPromptContainer;chosenPromptTemplate=null;CUSTOM_PROMPT_ID="__custom__";promptPreviewArea;textToRewrite;constructor(e,t,r,n){super(e),this.selectedText=t,this.plugin=r,this.editor=n,this.textToRewrite=t}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("coffee-tailored-prompt-modal"),e.createEl("h2",{text:"Tailored Rewrite"});let t=e.createDiv("text-container original-text-container text-to-rewrite-container");new v.Setting(t).setName("Text to Rewrite:").setHeading().settingEl.addClass("coffee-text-to-rewrite-label");let r=t.createDiv("modal-text-content");v.MarkdownRenderer.render(this.app,this.textToRewrite,r,"",this);let n=new v.Setting(e).setName("Prompt Template");this.promptPreviewArea=e.createDiv(),this.promptPreviewArea.addClass("coffee-tailored-prompt-preview"),this.promptPreviewArea.style.display="none",this.customPromptContainer=e.createDiv("custom-prompt-container-div"),this.customPromptContainer.addClass("coffee-tailored-custom-prompt-container"),this.customPromptContainer.style.display="none",n.addDropdown(s=>{this.promptSelect=s,this.plugin.cfg.promptTemplates.forEach(a=>{s.addOption(a.id,a.name)}),s.addOption(this.CUSTOM_PROMPT_ID,"-- Write a new custom prompt --");let l=!0;this.plugin.cfg.promptTemplates.length>0?(s.setValue(this.plugin.cfg.promptTemplates[0].id),this.chosenPromptTemplate=this.plugin.cfg.promptTemplates[0],l=!1):s.setValue(this.CUSTOM_PROMPT_ID),this.toggleCustomPromptUI(l),this.updatePromptPreview(s.getValue()),s.onChange(a=>{let d=a===this.CUSTOM_PROMPT_ID;d?this.chosenPromptTemplate=null:this.chosenPromptTemplate=this.plugin.cfg.promptTemplates.find(f=>f.id===a)||null,this.toggleCustomPromptUI(d),this.updatePromptPreview(a)})}),new v.Setting(this.customPromptContainer).setName("Custom Prompt").setDesc("Enter your custom prompt. The selected text will be appended to this.").addTextArea(s=>{this.promptTextArea=s,s.inputEl.rows=5,s.inputEl.cols=50,s.setPlaceholder("Example: Summarize this text for a 5-year-old."),s.inputEl.addClass("coffee-tailored-prompt-textarea")}),new v.Setting(e).addButton(s=>s.setButtonText("Rewrite with this prompt").setCta().onClick(()=>{let l="";if(this.chosenPromptTemplate)l=this.chosenPromptTemplate.prompt;else if(this.promptTextArea.getValue().trim())l=this.promptTextArea.getValue().trim();else{new v.Notice("Please select a template or enter a custom prompt.");return}this.close(),this.handleRewrite(l)}))}toggleCustomPromptUI(e){this.customPromptContainer&&this.promptPreviewArea&&(e?(this.customPromptContainer.style.display="block",this.promptPreviewArea.style.display="none"):(this.customPromptContainer.style.display="none",this.promptPreviewArea.style.display="block"))}updatePromptPreview(e){if(this.promptPreviewArea)if(e&&e!==this.CUSTOM_PROMPT_ID){let t=this.plugin.cfg.promptTemplates.find(r=>r.id===e);t?this.promptPreviewArea.textContent=t.prompt:this.promptPreviewArea.textContent="Prompt not found."}else this.promptPreviewArea.textContent=""}async handleRewrite(e){new v.Notice("\u2615\uFE0F Calling LLM with tailored prompt...");let t=await z(this.plugin.cfg,this.selectedText,e);if(!t){new v.Notice("Coffee Rewriter: Tailored rewrite request failed or returned empty.");return}let r=t.rewrittenText,n=t.note,o=r.trim();if(o===this.selectedText.trim()){new v.Notice("\u2705 Text looks good, tailored prompt resulted in no changes.");return}let s=l=>{let a=this.editor.getSelection();if(a&&a===this.selectedText)this.editor.replaceSelection(l);else{let d=this.editor.getCursor().line,f=this.editor.getLine(d);if(f===this.selectedText)this.editor.replaceRange(l,{line:d,ch:0},{line:d,ch:f.length});else{let m=this.editor.getValue().indexOf(this.selectedText);if(m>=0){let u=this.editor.offsetToPos(m),c=this.editor.offsetToPos(m+this.selectedText.length);this.editor.replaceRange(l,u,c)}else{let u=this.editor.listSelections()[0];if(u)this.editor.replaceRange(l,u.anchor,u.head);else{new v.Notice("Could not locate the original text to replace.");return}}}}new v.Notice("\u2615\uFE0F Tailored rewrite accepted!")};new I(this.app,this.selectedText,o,s,!1,n,()=>{new D(this.app,this.selectedText,o,l=>{new i(this.app,l,this.plugin,this.editor).open()}).open()}).open()}onClose(){let{contentEl:e}=this;e.empty()}};async function Z(i,e){let t=e.getSelection(),r=!!t,n=t||e.getLine(e.getCursor().line),o=e.getCursor().line,s=r?null:e.getLine(o);if(!n.trim()){O("Coffee Rewriter: Nothing to rewrite.");return}O("\u2615\uFE0F Calling LLM to rewrite text...");let l=await z(i.cfg,n);if(!l){O("Coffee Rewriter: Rewrite request failed or returned empty.");return}let a=l.rewrittenText.trim(),d=l.note;if(a===n.trim()){O("\u2705 Text looks good, nothing to change.");return}let f=a;if(i.cfg.preserveQuotes){let m=n.match(/"([^"]+)"/g)||[],u=f.match(/"([^"]+)"/g)||[];if(m.length===u.length){let c=f;for(let g=0;g<m.length;g++)c=c.replace(u[g],m[g]);f=c}}let p=m=>{if(r&&e.getSelection()===n)e.replaceSelection(m);else if(s!==null&&s===n)e.replaceRange(m,{line:o,ch:0},{line:o,ch:s.length});else{let c=e.getValue().indexOf(n);if(c>=0){let g=e.offsetToPos(c),x=e.offsetToPos(c+n.length);e.replaceRange(m,g,x)}else s!==null&&e.replaceRange(m,{line:o,ch:0},{line:o,ch:s.length})}O("\u2615\uFE0F Rewrite accepted!")};new I(i.app,n,f,p,!0,d,()=>{new D(i.app,n,f,m=>{new A(i.app,m,i,e).open()}).open()}).open()}var G=class extends $.Plugin{settings=K;async onload(){await this.loadSettings(),this.addSettingTab(new U(this.app,this)),this.addCommand({id:"coffee-quick-rewrite",name:"Quick Rewrite (Paragraph / Selection)",editorCallback:e=>Z(this,e),icon:"bot"}),this.addCommand({id:"coffee-tailored-rewrite",name:"Tailored rewrite",editorCallback:e=>{let t=e.getSelection()||e.getLine(e.getCursor().line);if(!t.trim()){new $.Notice("Nothing selected to rewrite.");return}new A(this.app,t,this,e).open()},icon:"edit"}),this.registerEvent(this.app.workspace.on("editor-menu",(e,t)=>{e.addItem(r=>{r.setTitle("Quick Rewrite (Paragraph / Selection)").setIcon("bot").onClick(()=>Z(this,t))}),e.addItem(r=>{r.setTitle("Tailored rewrite").setIcon("bot").onClick(()=>{let n=t.getSelection()||t.getLine(t.getCursor().line);if(!n.trim()){new $.Notice("Nothing selected to rewrite.");return}new A(this.app,n,this,t).open()})})})),console.info("Coffee Rewriter loaded \u2615\uFE0F")}onunload(){console.info("Coffee Rewriter unloaded \u2615\uFE0F")}async loadSettings(){this.settings=Object.assign({},K,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}get cfg(){return this.settings}};
