/* THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the GitHub repository of this plugin. */

"use strict";var V=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var ve=Object.getOwnPropertyNames;var ye=Object.prototype.hasOwnProperty;var Te=(r,e)=>{for(var n in e)V(r,n,{get:e[n],enumerable:!0})},Ce=(r,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of ve(e))!ye.call(r,t)&&t!==n&&V(r,t,{get:()=>e[t],enumerable:!(i=we(e,t))||i.enumerable});return r};var xe=r=>Ce(V({},"__esModule",{value:!0}),r);var be={};Te(be,{default:()=>z});module.exports=xe(be);var q=require("obsidian");var h=require("obsidian");var A=require("obsidian");async function ee(r,e,n){let{openAiKey:i,openAiModel:t}=r;if(!i){new A.Notice("Coffee Rewriter: OpenAI key missing. Add it in the settings.");return}try{return(await(0,A.requestUrl)({url:"https://api.openai.com/v1/chat/completions",method:"POST",contentType:"application/json",headers:{Authorization:`Bearer ${i}`},body:JSON.stringify({model:t,messages:[{role:"system",content:n},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content}catch(o){console.error("Coffee Rewriter \u2013 OpenAI error",o),new A.Notice("Coffee Rewriter: OpenAI request failed (see console).");return}}async function te(r){let{openAiKey:e}=r;if(!e)return[];try{let i=(await(0,A.requestUrl)({url:"https://api.openai.com/v1/models",method:"GET",headers:{Authorization:`Bearer ${e}`}})).json;return i&&Array.isArray(i.data)?i.data.map(t=>t.id).filter(Boolean):[]}catch(n){return console.error("Coffee Rewriter \u2013 OpenAI models error",n),[]}}var I=require("obsidian");async function ne(r,e,n){let{geminiKey:i,geminiModel:t}=r;if(!i){new I.Notice("Coffee Rewriter: Gemini API key missing.");return}try{let o=`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent?key=${i}`;return(await(0,I.requestUrl)({url:o,method:"POST",contentType:"application/json",body:JSON.stringify({contents:[{role:"user",parts:[{text:`${n}

${e}`}]}]})})).json?.candidates?.[0]?.content?.parts?.[0]?.text}catch(o){console.error("Coffee Rewriter \u2013 Gemini error",o),new I.Notice("Coffee Rewriter: Gemini request failed (see console).");return}}async function ie(r){let{geminiKey:e}=r;if(!e)return[];try{let i=(await(0,I.requestUrl)({url:`https://generativelanguage.googleapis.com/v1beta/models?key=${e}`,method:"GET"})).json;return i&&Array.isArray(i.models)?i.models.map(t=>t.name).filter(Boolean):[]}catch(n){return console.error("Coffee Rewriter \u2013 Gemini models error",n),[]}}var N=require("obsidian");function $(r){return r.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}async function re(r,e,n){let{lmstudioEndpoint:i,lmStudioModel:t,stripReasoning:o}=r;try{let s=(await(0,N.requestUrl)({url:`${i}/v1/chat/completions`,method:"POST",contentType:"application/json",body:JSON.stringify({model:t,messages:[{role:"system",content:n},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content;return s&&(o?$(s):s)}catch(l){console.error("Coffee Rewriter \u2013 LM Studio error",l),new N.Notice("Coffee Rewriter: Could not reach LM Studio server.");return}}async function oe(r){let{lmstudioEndpoint:e}=r;try{let i=(await(0,N.requestUrl)({url:`${e}/v1/models`,method:"GET",contentType:"application/json"})).json;return i&&Array.isArray(i.data)?i.data.map(t=>t.id).filter(Boolean):[]}catch(n){return console.error("Coffee Rewriter \u2013 LM Studio models",n),[]}}var E=require("obsidian");async function se(r,e,n){let{claudeKey:i,claudeModel:t}=r;if(!i){new E.Notice("Coffee Rewriter: Claude API key missing. Add it in the settings.");return}try{let l=(await(0,E.requestUrl)({url:"https://api.anthropic.com/v1/messages",method:"POST",contentType:"application/json",headers:{"x-api-key":i,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:t,max_tokens:2048,system:n,messages:[{role:"user",content:e}]})})).json?.content?.[0];return l&&l.type==="text"?l.text:void 0}catch(o){console.error("Coffee Rewriter \u2013 Claude error",o),new E.Notice("Coffee Rewriter: Claude request failed (see console).");return}}async function le(r){let{claudeKey:e}=r;if(!e)return[];try{let i=(await(0,E.requestUrl)({url:"https://api.anthropic.com/v1/models",method:"GET",contentType:"application/json",headers:{"x-api-key":e,"anthropic-version":"2023-06-01"}})).json;return i&&Array.isArray(i.data)?i.data.map(t=>t.id).filter(Boolean):[]}catch(n){return console.error("Coffee Rewriter \u2013 Claude models error",n),[]}}var D=require("obsidian");async function ae(r,e,n){let{ollamaEndpoint:i,ollamaModel:t,stripReasoning:o}=r;try{let s=(await(0,D.requestUrl)({url:`${i}/v1/chat/completions`,method:"POST",contentType:"application/json",body:JSON.stringify({model:t,messages:[{role:"system",content:n},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content;return s&&(o?$(s):s)}catch(l){console.error("Coffee Rewriter \u2013 Ollama error",l),new D.Notice("Coffee Rewriter: Could not reach Ollama server.");return}}async function pe(r){let{ollamaEndpoint:e}=r;try{let i=(await(0,D.requestUrl)({url:`${e}/v1/models`,method:"GET",contentType:"application/json"})).json;return i&&Array.isArray(i.data)?i.data.map(t=>t.id).filter(Boolean):[]}catch(n){return console.error("Coffee Rewriter \u2013 Ollama models",n),[]}}var C=require("obsidian"),F=class extends C.Modal{plugin;template;isNew;onSave;nameInput;promptInput;constructor(e,n,i,t){super(e),this.plugin=n,this.onSave=t,i?(this.isNew=!1,this.template={...i}):(this.isNew=!0,this.template={id:`custom-${new Date().getTime()}`,name:"",prompt:""})}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("coffee-prompt-edit-modal"),e.createEl("h2",{text:this.isNew?"Add New Prompt Template":"Edit Prompt Template"});let n=!this.isNew&&this.plugin.cfg.promptTemplates.length>0&&this.plugin.cfg.promptTemplates[0].id===this.template.id;n||new C.Setting(e).setName("Template Name").addText(i=>{this.nameInput=i,i.setValue(this.template.name).setPlaceholder("Enter template name (e.g., Summarize for Twitter)")}),new C.Setting(e).setName("Prompt Content"),this.promptInput=new C.TextAreaComponent(e).setValue(this.template.prompt).setPlaceholder("Enter the full prompt here. The selected text will be appended when used."),this.promptInput.inputEl.rows=8,this.promptInput.inputEl.addClass("coffee-settings-prompt-textarea"),this.promptInput.inputEl.style.width="100%",this.promptInput.inputEl.style.marginTop="var(--size-2-2)",new C.Setting(e).addButton(i=>i.setButtonText("Save").setCta().onClick(()=>{if(this.nameInput&&(this.template.name=this.nameInput.getValue().trim()),this.template.prompt=this.promptInput.getValue().trim(),!this.template.name&&!n){new C.Notice("Template name cannot be empty.");return}else n&&(this.template.name=this.plugin.cfg.promptTemplates[0].name);if(!this.template.prompt){new C.Notice("Prompt content cannot be empty.");return}this.onSave({action:"save",template:this.template}),this.close()})).addButton(i=>i.setButtonText("Cancel").onClick(()=>{this.close()}))}onClose(){let{contentEl:e}=this;e.empty()}};var j={provider:"openai",openAiKey:"",openAiModel:"gpt-3.5-turbo",geminiKey:"",geminiModel:"gemini-pro",lmstudioEndpoint:"http://localhost:1234",lmStudioModel:"",promptTemplates:[{id:"default-quick-rewrite",name:"Quick Rewrite",prompt:"Improve clarity, grammar, and conciseness of the following text. Return only the improved version."},{id:"pirate-speak",name:"Pirate Speak",prompt:"Rewrite the following text as if you were a swashbuckling pirate, arrr! Keep the core meaning but infuse it with pirate slang and bravado."},{id:"professional-tone",name:"Professional Tone",prompt:"Please rewrite the following text in a more professional and formal tone. Ensure clarity, conciseness, and appropriate business language. Avoid jargon where possible, or explain it if necessary."},{id:"academic-phd-style",name:"Academic (PhD Style)",prompt:"Please revise the following text to reflect the style, depth, and rigor of a PhD-level academic paper. Focus on sophisticated vocabulary, nuanced argumentation, formal scholarly tone, and logical precision."}],preserveQuotes:!1,stripReasoning:!1,claudeKey:"",claudeModel:"claude-3-haiku-20240307",ollamaEndpoint:"http://localhost:11434",ollamaModel:""},U=class extends h.PluginSettingTab{plugin;selectedTemplateIdForEditing=null;promptTemplateSettingsContainer;constructor(e,n){super(e,n),this.plugin=n,this.plugin.cfg.promptTemplates&&this.plugin.cfg.promptTemplates.length>0&&(this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id)}addTextSetting(e,n,i,t,o,l=!1){new h.Setting(e).setName(n).setDesc(i).addText(s=>{l&&(s.inputEl.type="password"),s.setValue(t()).onChange(async a=>{o(a.trim()),await this.plugin.saveSettings()})})}async addModelDropdownSetting(e,n,i,t,o,l){let s=new h.Setting(e).setName(n).setDesc(i),a=null,d=null,c=async p=>{if(!a)return;let u=!1,w="API Key",f="";switch(t){case"openai":u=!!this.plugin.cfg.openAiKey,w="API Key",f="OpenAI API Key";break;case"gemini":u=!!this.plugin.cfg.geminiKey,w="API Key",f="Gemini API Key";break;case"claude":u=!!this.plugin.cfg.claudeKey,w="API Key",f="Claude API Key";break;case"lmstudio":u=!!this.plugin.cfg.lmstudioEndpoint,w="Server URL",f="LM Studio Server URL";break;case"ollama":u=!!this.plugin.cfg.ollamaEndpoint,w="Server URL",f="Ollama Server URL";break;default:a.selectEl.options.length=0,a.addOption("","--Provider error--"),a.setValue(""),a.selectEl.disabled=!0,d&&d.setDisabled(!0),s.setDesc(i+" (Unknown provider configuration)");return}let v=`--Set ${w} First--`,L=`Set ${f} to load models`;if(!u){a.selectEl.options.length=0,a.addOption("",v),a.setValue(""),a.selectEl.disabled=!0,d&&d.setDisabled(!0),s.setDesc(i+` (${L})`);return}a.selectEl.disabled=!0,d&&d.setDisabled(!0),s.setDesc(i+(p?" (Refreshing models...)":" (Loading models...)"));let m=[];try{switch(t){case"openai":m=await te(this.plugin.cfg);break;case"gemini":m=await ie(this.plugin.cfg),m=m.map(T=>T.startsWith("models/")?T.split("/")[1]:T);break;case"claude":m=await le(this.plugin.cfg);break;case"lmstudio":m=await oe(this.plugin.cfg);break;case"ollama":m=await pe(this.plugin.cfg);break}}catch(T){new h.Notice(`Failed to load models for ${t}. Check console.`),console.error(`Coffee Rewriter - Error loading models for ${t}:`,T)}s.setDesc(i),a.selectEl.disabled=!1,d&&d.setDisabled(!1),a.selectEl.options.length=0,m.length===0?a.addOption("","--No models found or loaded--"):(a.addOption("","--Select Model--"),m.forEach(T=>{a&&a.addOption(T,T)})),a.setValue(o())};s.addDropdown(async p=>{a=p,p.selectEl.options.length=0,p.addOption("","--Select Model--"),p.setValue(o()),p.onChange(async u=>{l(u),await this.plugin.saveSettings()}),await c(!1)}),s.addButton(p=>{d=p,p.setIcon("refresh-cw").setTooltip("Refresh model list").onClick(async()=>{await c(!0)})})}renderPromptTemplateEditor(){this.promptTemplateSettingsContainer.empty(),(!this.plugin.cfg.promptTemplates||this.plugin.cfg.promptTemplates.length===0)&&(this.plugin.cfg.promptTemplates=j.promptTemplates.map(t=>({...t})),this.plugin.saveSettings(),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates.length>0?this.plugin.cfg.promptTemplates[0].id:null),!this.selectedTemplateIdForEditing&&this.plugin.cfg.promptTemplates.length>0?this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id:this.plugin.cfg.promptTemplates.length===0&&(this.selectedTemplateIdForEditing=null);let e=new h.Setting(this.promptTemplateSettingsContainer).setName("Manage Templates");e.addButton(t=>t.setIcon("plus").setTooltip("Add new prompt template").setCta().onClick(()=>{new F(this.app,this.plugin,null,this.handlePromptSaveAction.bind(this)).open()})),e.addDropdown(t=>{this.plugin.cfg.promptTemplates.length===0?(t.addOption("__none__","-- No templates defined --"),t.setDisabled(!0)):this.plugin.cfg.promptTemplates.forEach(o=>{t.addOption(o.id,o.name)}),this.selectedTemplateIdForEditing?t.setValue(this.selectedTemplateIdForEditing):this.plugin.cfg.promptTemplates.length>0&&(t.setValue(this.plugin.cfg.promptTemplates[0].id),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id),t.onChange(async o=>{this.selectedTemplateIdForEditing=o,this.renderPromptTemplateEditor()})}),e.addButton(t=>t.setIcon("pencil").setTooltip("Edit selected prompt template").onClick(()=>{let o=this.plugin.cfg.promptTemplates.find(l=>l.id===this.selectedTemplateIdForEditing);o?new F(this.app,this.plugin,o,this.handlePromptSaveAction.bind(this)).open():new h.Notice("No template selected to edit. Please add one first if the list is empty.")}));let n=this.plugin.cfg.promptTemplates.find(t=>t.id===this.selectedTemplateIdForEditing),i=n?this.plugin.cfg.promptTemplates.indexOf(n)===0:!1;if(n&&!i&&e.addButton(t=>t.setIcon("trash").setTooltip("Delete selected prompt template").setWarning().onClick(async()=>{let o=this.plugin.cfg.promptTemplates.findIndex(l=>l.id===this.selectedTemplateIdForEditing);o>0?(this.plugin.cfg.promptTemplates.splice(o,1),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id,await this.plugin.saveSettings(),this.renderPromptTemplateEditor()):new h.Notice("Cannot delete this template.")})),n){new h.Setting(this.promptTemplateSettingsContainer).setName("Selected Prompt Content").setDesc("Content of the template selected above. Click the pencil icon to edit.");let t=this.promptTemplateSettingsContainer.createDiv({cls:"coffee-prompt-display-box"});t.setText(n.prompt),t.style.width="100%",t.style.padding="var(--size-2-3)",t.style.border="1px solid var(--background-modifier-border)",t.style.borderRadius="var(--radius-m)",t.style.backgroundColor="var(--background-secondary)",t.style.whiteSpace="pre-wrap",t.style.wordBreak="break-word",t.style.maxHeight="150px",t.style.overflowY="auto",t.style.marginTop="var(--size-2-2)",t.style.marginBottom="var(--size-4-4)"}else this.plugin.cfg.promptTemplates.length>0&&this.selectedTemplateIdForEditing&&new h.Setting(this.promptTemplateSettingsContainer).setName("Error").setDesc("Could not display selected prompt. Please try selecting again.")}async handlePromptSaveAction(e){let n=!1,i=this.selectedTemplateIdForEditing;if(e.action==="save"){let{template:t}=e,o=this.plugin.cfg.promptTemplates.findIndex(l=>l.id===t.id);o>-1?this.plugin.cfg.promptTemplates[o]=t:(this.plugin.cfg.promptTemplates.push(t),i=t.id),n=!0}n&&(this.selectedTemplateIdForEditing=i,await this.plugin.saveSettings(),this.renderPromptTemplateEditor())}display(){let{containerEl:e}=this;e.empty(),e.createEl("h3",{text:"LLM Provider Settings"}),new h.Setting(e).setName("LLM Provider").setDesc("Choose which backend to use for rewriting.").addDropdown(t=>{t.addOption("openai","OpenAI"),t.addOption("gemini","Gemini"),t.addOption("lmstudio","LM Studio"),t.addOption("claude","Claude (Anthropic)"),t.addOption("ollama","Ollama"),t.setValue(this.plugin.cfg.provider).onChange(async o=>{this.plugin.cfg.provider=o,await this.plugin.saveSettings(),this.display()})});let n=this.plugin.cfg.provider;n==="openai"?(this.addTextSetting(e,"API Key","Your OpenAI secret key.",()=>this.plugin.cfg.openAiKey,t=>this.plugin.cfg.openAiKey=t,!0),this.addModelDropdownSetting(e,"Model","OpenAI model.","openai",()=>this.plugin.cfg.openAiModel,t=>this.plugin.cfg.openAiModel=t)):n==="gemini"?(this.addTextSetting(e,"API Key","Google AI API key.",()=>this.plugin.cfg.geminiKey,t=>this.plugin.cfg.geminiKey=t,!0),this.addModelDropdownSetting(e,"Model","Gemini model.","gemini",()=>this.plugin.cfg.geminiModel,t=>this.plugin.cfg.geminiModel=t)):n==="lmstudio"?(this.addTextSetting(e,"Server URL","LM Studio endpoint (http://host:port)",()=>this.plugin.cfg.lmstudioEndpoint,t=>this.plugin.cfg.lmstudioEndpoint=t),this.addModelDropdownSetting(e,"Model","LM Studio model (requires server to be running).","lmstudio",()=>this.plugin.cfg.lmStudioModel,t=>this.plugin.cfg.lmStudioModel=t)):n==="claude"?(this.addTextSetting(e,"API Key","Your Anthropic Claude API key.",()=>this.plugin.cfg.claudeKey,t=>this.plugin.cfg.claudeKey=t,!0),this.addModelDropdownSetting(e,"Model","Claude model.","claude",()=>this.plugin.cfg.claudeModel,t=>this.plugin.cfg.claudeModel=t)):n==="ollama"&&(this.addTextSetting(e,"Server URL","Ollama endpoint (http://host:port)",()=>this.plugin.cfg.ollamaEndpoint,t=>this.plugin.cfg.ollamaEndpoint=t),this.addModelDropdownSetting(e,"Model","Ollama model (requires server to be running).","ollama",()=>this.plugin.cfg.ollamaModel,t=>this.plugin.cfg.ollamaModel=t)),e.createEl("h3",{text:"Prompts"}),this.promptTemplateSettingsContainer=e.createDiv("prompt-templates-settings-area"),this.renderPromptTemplateEditor(),e.createEl("h3",{text:"Other Settings"}),new h.Setting(e).setName("Preserve text inside quotes").setDesc('Do not rewrite text that is wrapped in "double quotes".').addToggle(t=>t.setValue(this.plugin.cfg.preserveQuotes).onChange(async o=>{this.plugin.cfg.preserveQuotes=o,await this.plugin.saveSettings()})),(n==="lmstudio"||n==="ollama")&&new h.Setting(e).setName("Strip <think> reasoning (local models)").setDesc("If your local model emits <think>...</think> blocks, strip them from the final output.").addToggle(t=>t.setValue(this.plugin.cfg.stripReasoning).onChange(async o=>{this.plugin.cfg.stripReasoning=o,await this.plugin.saveSettings()}))}};function Se(r){return`${r.trim()} Reply with a JSON object that contains two fields: "rewrittenText" with the improved version, and "note" with a brief note about what was changed. Always return valid JSON.`}function Le(r){if(r)try{let e=r.match(/\{[\s\S]*\}/);if(e){let n=e[0],i=JSON.parse(n);if(typeof i.rewrittenText=="string"&&typeof i.note=="string")return i}return{rewrittenText:r.trim(),note:"The AI didn't provide structured feedback for this rewrite."}}catch(e){return console.warn("Coffee Rewriter - Failed to parse LLM response as JSON:",e),{rewrittenText:r.trim(),note:"The AI didn't provide structured feedback for this rewrite."}}}async function B(r,e,n){let i;n!==void 0?i=n:r.promptTemplates&&r.promptTemplates.length>0&&r.promptTemplates[0]&&typeof r.promptTemplates[0].prompt=="string"?i=r.promptTemplates[0].prompt:(console.warn("Coffee Rewriter: Default prompt template not found or invalid. Using a fallback prompt."),i="Improve the following text.");let t=Se(i),o;switch(r.provider){case"openai":o=await ee(r,e,t);break;case"gemini":o=await ne(r,e,t);break;case"lmstudio":o=await re(r,e,t);break;case"claude":o=await se(r,e,t);break;case"ollama":o=await ae(r,e,t);break;default:console.warn(`Coffee Rewriter: Unknown provider: ${r.provider}`);return}return Le(o)}var fe=require("obsidian"),de;function P(r,e=4e3){de?.hide(),de=new fe.Notice(r,e)}var S=require("obsidian");function x(){}x.prototype={diff:function(e,n){var i,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=t.callback;typeof t=="function"&&(o=t,t={}),this.options=t;var l=this;function s(g){return o?(setTimeout(function(){o(void 0,g)},0),!0):g}e=this.castInput(e),n=this.castInput(n),e=this.removeEmpty(this.tokenize(e)),n=this.removeEmpty(this.tokenize(n));var a=n.length,d=e.length,c=1,p=a+d;t.maxEditLength&&(p=Math.min(p,t.maxEditLength));var u=(i=t.timeout)!==null&&i!==void 0?i:1/0,w=Date.now()+u,f=[{oldPos:-1,lastComponent:void 0}],v=this.extractCommon(f[0],n,e,0);if(f[0].oldPos+1>=d&&v+1>=a)return s([{value:this.join(n),count:n.length}]);var L=-1/0,m=1/0;function T(){for(var g=Math.max(L,-c);g<=Math.min(m,c);g+=2){var R=void 0,M=f[g-1],O=f[g+1];M&&(f[g-1]=void 0);var G=!1;if(O){var Z=O.oldPos-g;G=O&&0<=Z&&Z<a}var _=M&&M.oldPos+1<d;if(!G&&!_){f[g]=void 0;continue}if(!_||G&&M.oldPos+1<O.oldPos?R=l.addToPath(O,!0,void 0,0):R=l.addToPath(M,void 0,!0,1),v=l.extractCommon(R,n,e,g),R.oldPos+1>=d&&v+1>=a)return s(Re(l,R.lastComponent,n,e,l.useLongestToken));f[g]=R,R.oldPos+1>=d&&(m=Math.min(m,g-1)),v+1>=a&&(L=Math.max(L,g+1))}c++}if(o)(function g(){setTimeout(function(){if(c>p||Date.now()>w)return o();T()||g()},0)})();else for(;c<=p&&Date.now()<=w;){var X=T();if(X)return X}},addToPath:function(e,n,i,t){var o=e.lastComponent;return o&&o.added===n&&o.removed===i?{oldPos:e.oldPos+t,lastComponent:{count:o.count+1,added:n,removed:i,previousComponent:o.previousComponent}}:{oldPos:e.oldPos+t,lastComponent:{count:1,added:n,removed:i,previousComponent:o}}},extractCommon:function(e,n,i,t){for(var o=n.length,l=i.length,s=e.oldPos,a=s-t,d=0;a+1<o&&s+1<l&&this.equals(n[a+1],i[s+1]);)a++,s++,d++;return d&&(e.lastComponent={count:d,previousComponent:e.lastComponent}),e.oldPos=s,a},equals:function(e,n){return this.options.comparator?this.options.comparator(e,n):e===n||this.options.ignoreCase&&e.toLowerCase()===n.toLowerCase()},removeEmpty:function(e){for(var n=[],i=0;i<e.length;i++)e[i]&&n.push(e[i]);return n},castInput:function(e){return e},tokenize:function(e){return e.split("")},join:function(e){return e.join("")}};function Re(r,e,n,i,t){for(var o=[],l;e;)o.push(e),l=e.previousComponent,delete e.previousComponent,e=l;o.reverse();for(var s=0,a=o.length,d=0,c=0;s<a;s++){var p=o[s];if(p.removed){if(p.value=r.join(i.slice(c,c+p.count)),c+=p.count,s&&o[s-1].added){var w=o[s-1];o[s-1]=o[s],o[s]=w}}else{if(!p.added&&t){var u=n.slice(d,d+p.count);u=u.map(function(v,L){var m=i[c+L];return m.length>v.length?m:v}),p.value=r.join(u)}else p.value=r.join(n.slice(d,d+p.count));d+=p.count,p.added||(c+=p.count)}}var f=o[a-1];return a>1&&typeof f.value=="string"&&(f.added||f.removed)&&r.equals("",f.value)&&(o[a-2].value+=f.value,o.pop()),o}var pt=new x;function Ae(r,e){if(typeof r=="function")e.callback=r;else if(r)for(var n in r)r.hasOwnProperty(n)&&(e[n]=r[n]);return e}var ce=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,ue=/\S/,Q=new x;Q.equals=function(r,e){return this.options.ignoreCase&&(r=r.toLowerCase(),e=e.toLowerCase()),r===e||this.options.ignoreWhitespace&&!ue.test(r)&&!ue.test(e)};Q.tokenize=function(r){for(var e=r.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),n=0;n<e.length-1;n++)!e[n+1]&&e[n+2]&&ce.test(e[n])&&ce.test(e[n+2])&&(e[n]+=e[n+2],e.splice(n+1,2),n--);return e};function me(r,e,n){return n=Ae(n,{ignoreWhitespace:!0}),Q.diff(r,e,n)}var ge=new x;ge.tokenize=function(r){this.options.stripTrailingCr&&(r=r.replace(/\r\n/g,`
`));var e=[],n=r.split(/(\n|\r\n)/);n[n.length-1]||n.pop();for(var i=0;i<n.length;i++){var t=n[i];i%2&&!this.options.newlineIsToken?e[e.length-1]+=t:(this.options.ignoreWhitespace&&(t=t.trim()),e.push(t))}return e};var Ie=new x;Ie.tokenize=function(r){return r.split(/(\S.+?[.!?])(?=\s+|$)/)};var Ee=new x;Ee.tokenize=function(r){return r.split(/([{}:;,]|\s+)/)};function K(r){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?K=function(e){return typeof e}:K=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},K(r)}var Pe=Object.prototype.toString,k=new x;k.useLongestToken=!0;k.tokenize=ge.tokenize;k.castInput=function(r){var e=this.options,n=e.undefinedReplacement,i=e.stringifyReplacer,t=i===void 0?function(o,l){return typeof l>"u"?n:l}:i;return typeof r=="string"?r:JSON.stringify(W(r,null,null,t),t,"  ")};k.equals=function(r,e){return x.prototype.equals.call(k,r.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"))};function W(r,e,n,i,t){e=e||[],n=n||[],i&&(r=i(t,r));var o;for(o=0;o<e.length;o+=1)if(e[o]===r)return n[o];var l;if(Pe.call(r)==="[object Array]"){for(e.push(r),l=new Array(r.length),n.push(l),o=0;o<r.length;o+=1)l[o]=W(r[o],e,n,i,t);return e.pop(),n.pop(),l}if(r&&r.toJSON&&(r=r.toJSON()),K(r)==="object"&&r!==null){e.push(r),l={},n.push(l);var s=[],a;for(a in r)r.hasOwnProperty(a)&&s.push(a);for(s.sort(),o=0;o<s.length;o+=1)a=s[o],l[a]=W(r[a],e,n,i,a);e.pop(),n.pop()}else l=r;return l}var J=new x;J.tokenize=function(r){return r.slice()};J.join=J.removeEmpty=function(r){return r};function he(r,e){let n=0,i=0;return{annotated:me(r,e).map(o=>{if(o.added){n+=1;let l=o.value,s=l.match(/^(\\s*)/),a=s?s[0]:"",d=l.match(/(\\s*)$/),c=d?d[0]:"",p=l;return c.length>0&&(p=p.substring(0,p.length-c.length)),a.length>0&&(p=p.substring(a.length)),p.length>0?`${a}==${p}==${c}`:`==${l}==`}return o.removed?(i+=1,""):o.value}).join(""),additions:n,removals:i}}var b=class extends S.Modal{originalText;rewrittenText;rewriteNote;onAcceptAll;showDiff;constructor(e,n,i,t,o=!0,l){super(e),this.originalText=n,this.rewrittenText=i,this.rewriteNote=l,this.onAcceptAll=t,this.showDiff=o}onOpen(){let{contentEl:e}=this;if(e.empty(),e.addClass("coffee-rewrite-modal"),e.createEl("h2",{text:"Review Rewrite"}),this.rewriteNote){let s=e.createDiv("note-container");s.createEl("h4",{text:"Note from the AI"}),s.createDiv("note-content").setText(this.rewriteNote)}let n=e.createDiv("text-container original-text-container");n.createEl("h4",{text:"Original"});let i=n.createDiv("modal-text-content");S.MarkdownRenderer.render(this.app,this.originalText,i,"",this);let t=e.createDiv("text-container rewritten-text-container"),o=this.showDiff?"Rewritten (changes highlighted)":"Rewritten Text";t.createEl("h4",{text:o});let l=t.createDiv("modal-text-content");if(this.showDiff){let a=he(this.originalText,this.rewrittenText).annotated;S.MarkdownRenderer.render(this.app,a,l,"",this)}else S.MarkdownRenderer.render(this.app,this.rewrittenText,l,"",this);new S.Setting(e).addButton(s=>s.setButtonText("Accept").setCta().onClick(()=>{this.onAcceptAll(this.rewrittenText),this.close()})).addButton(s=>s.setButtonText("Cancel").onClick(()=>{this.close()}))}onClose(){let{contentEl:e}=this;e.empty()}};async function Y(r,e){let n=e.getSelection(),i=!!n,t=n||e.getLine(e.getCursor().line),o=e.getCursor().line,l=i?null:e.getLine(o);if(!t.trim()){P("Coffee Rewriter: Nothing to rewrite.");return}P("\u2615\uFE0F Calling LLM to rewrite text...");let s=await B(r.cfg,t);if(!s){P("Coffee Rewriter: Rewrite request failed or returned empty.");return}let a=s.rewrittenText.trim(),d=s.note;if(a===t.trim()){P("\u2705 Text looks good, nothing to change.");return}let c=a;if(r.cfg.preserveQuotes){let u=t.match(/"([^"]+)"/g)||[],w=c.match(/"([^"]+)"/g)||[];if(u.length===w.length){let f=c;for(let v=0;v<u.length;v++)f=f.replace(w[v],u[v]);c=f}}let p=u=>{i?e.replaceSelection(u):l!==null&&e.replaceRange(u,{line:o,ch:0},{line:o,ch:l.length}),P("\u2615\uFE0F Rewrite accepted!")};new b(r.app,t,c,p,!0,d).open()}var y=require("obsidian");var H=class extends y.Modal{selectedText;plugin;editor;promptTextArea;promptSelect;customPromptContainer;chosenPromptTemplate=null;CUSTOM_PROMPT_ID="__custom__";constructor(e,n,i,t){super(e),this.selectedText=n,this.plugin=i,this.editor=t}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("coffee-tailored-prompt-modal"),e.createEl("h2",{text:"Tailored Rewrite"}),e.createEl("p",{text:"Select a prompt template or write your own:"}),new y.Setting(e).setName("Prompt Template").addDropdown(i=>{this.promptSelect=i,this.plugin.cfg.promptTemplates.forEach(t=>{i.addOption(t.id,t.name)}),i.addOption(this.CUSTOM_PROMPT_ID,"-- Write a new custom prompt --"),this.plugin.cfg.promptTemplates.length>0?(i.setValue(this.plugin.cfg.promptTemplates[0].id),this.chosenPromptTemplate=this.plugin.cfg.promptTemplates[0],this.toggleCustomPromptUI(!1)):(i.setValue(this.CUSTOM_PROMPT_ID),this.toggleCustomPromptUI(!0)),i.onChange(t=>{t===this.CUSTOM_PROMPT_ID?(this.chosenPromptTemplate=null,this.toggleCustomPromptUI(!0)):(this.chosenPromptTemplate=this.plugin.cfg.promptTemplates.find(o=>o.id===t)||null,this.toggleCustomPromptUI(!1))})}),this.customPromptContainer=e.createDiv("custom-prompt-container-div"),this.customPromptContainer.addClass("coffee-tailored-custom-prompt-container"),new y.Setting(this.customPromptContainer).setName("Custom Prompt").setDesc("Enter your custom prompt. The selected text will be appended to this.").addTextArea(i=>{this.promptTextArea=i,i.inputEl.rows=5,i.inputEl.cols=50,i.setPlaceholder("Example: Summarize this text for a 5-year-old."),i.inputEl.addClass("coffee-tailored-prompt-textarea")}),this.toggleCustomPromptUI(this.promptSelect.getValue()===this.CUSTOM_PROMPT_ID),new y.Setting(e).addButton(i=>i.setButtonText("Rewrite with this prompt").setCta().onClick(()=>{let t="";if(this.chosenPromptTemplate)t=this.chosenPromptTemplate.prompt;else if(this.promptTextArea.getValue().trim())t=this.promptTextArea.getValue().trim();else{new y.Notice("Please select a template or enter a custom prompt.");return}this.close(),this.handleRewrite(t)}))}toggleCustomPromptUI(e){this.customPromptContainer&&(e?this.customPromptContainer.style.display="block":this.customPromptContainer.style.display="none")}async handleRewrite(e){new y.Notice("\u2615\uFE0F Calling LLM with tailored prompt...");let n=await B(this.plugin.cfg,this.selectedText,e);if(!n){new y.Notice("Coffee Rewriter: Tailored rewrite request failed or returned empty.");return}let i=n.rewrittenText,t=n.note,o=i.trim();if(o===this.selectedText.trim()){new y.Notice("\u2705 Text looks good, tailored prompt resulted in no changes.");return}let l=s=>{if(this.editor.getSelection()===this.selectedText)this.editor.replaceSelection(s);else{let d=this.editor.listSelections()[0];if(d)this.editor.replaceRange(s,d.anchor,d.head);else{new y.Notice("Could not apply rewrite: editor selection changed.");return}}new y.Notice("\u2615\uFE0F Tailored rewrite accepted!")};new b(this.app,this.selectedText,o,l,!1,t).open()}onClose(){let{contentEl:e}=this;e.empty()}};var z=class extends q.Plugin{settings=j;async onload(){await this.loadSettings(),this.addSettingTab(new U(this.app,this)),this.addCommand({id:"coffee-quick-rewrite",name:"Quick Rewrite (Paragraph / Selection)",editorCallback:e=>Y(this,e),icon:"bot"}),this.addCommand({id:"coffee-tailored-rewrite",name:"Tailored rewrite",editorCallback:e=>{let n=e.getSelection()||e.getLine(e.getCursor().line);if(!n.trim()){new q.Notice("Nothing selected to rewrite.");return}new H(this.app,n,this,e).open()},icon:"edit"}),this.registerEvent(this.app.workspace.on("editor-menu",(e,n)=>{e.addItem(i=>{i.setTitle("Quick Rewrite (Paragraph / Selection)").setIcon("bot").onClick(()=>Y(this,n))}),e.addItem(i=>{i.setTitle("Tailored rewrite").setIcon("bot").onClick(()=>{let t=n.getSelection()||n.getLine(n.getCursor().line);if(!t.trim()){new q.Notice("Nothing selected to rewrite.");return}new H(this.app,t,this,n).open()})})})),console.info("Coffee Rewriter loaded \u2615\uFE0F")}onunload(){console.info("Coffee Rewriter unloaded \u2615\uFE0F")}async loadSettings(){this.settings=Object.assign({},j,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}get cfg(){return this.settings}};
