/* THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the GitHub repository of this plugin. */

"use strict";var J=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var ve=Object.getOwnPropertyNames;var ye=Object.prototype.hasOwnProperty;var Te=(i,e)=>{for(var n in e)J(i,n,{get:e[n],enumerable:!0})},Ce=(i,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of ve(e))!ye.call(i,t)&&t!==n&&J(i,t,{get:()=>e[t],enumerable:!(r=we(e,t))||r.enumerable});return i};var xe=i=>Ce(J({},"__esModule",{value:!0}),i);var Ie={};Te(Ie,{default:()=>z});module.exports=xe(Ie);var q=require("obsidian");var h=require("obsidian");var R=require("obsidian");async function ee(i,e,n){let{openAiKey:r,openAiModel:t}=i;if(!r){new R.Notice("Coffee Rewriter: OpenAI key missing. Add it in the settings.");return}try{return(await(0,R.requestUrl)({url:"https://api.openai.com/v1/chat/completions",method:"POST",contentType:"application/json",headers:{Authorization:`Bearer ${r}`},body:JSON.stringify({model:t,messages:[{role:"system",content:n},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content}catch(o){console.error("Coffee Rewriter \u2013 OpenAI error",o),new R.Notice("Coffee Rewriter: OpenAI request failed (see console).");return}}async function te(i){let{openAiKey:e}=i;if(!e)return[];try{let r=(await(0,R.requestUrl)({url:"https://api.openai.com/v1/models",method:"GET",headers:{Authorization:`Bearer ${e}`}})).json;return r&&Array.isArray(r.data)?r.data.map(t=>t.id).filter(Boolean):[]}catch(n){return console.error("Coffee Rewriter \u2013 OpenAI models error",n),[]}}var P=require("obsidian");async function ne(i,e,n){let{geminiKey:r,geminiModel:t}=i;if(!r){new P.Notice("Coffee Rewriter: Gemini API key missing.");return}try{let o=`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent?key=${r}`;return(await(0,P.requestUrl)({url:o,method:"POST",contentType:"application/json",body:JSON.stringify({contents:[{role:"user",parts:[{text:`${n}

${e}`}]}]})})).json?.candidates?.[0]?.content?.parts?.[0]?.text}catch(o){console.error("Coffee Rewriter \u2013 Gemini error",o),new P.Notice("Coffee Rewriter: Gemini request failed (see console).");return}}async function ie(i){let{geminiKey:e}=i;if(!e)return[];try{let r=(await(0,P.requestUrl)({url:`https://generativelanguage.googleapis.com/v1beta/models?key=${e}`,method:"GET"})).json;return r&&Array.isArray(r.models)?r.models.map(t=>t.name).filter(Boolean):[]}catch(n){return console.error("Coffee Rewriter \u2013 Gemini models error",n),[]}}var N=require("obsidian");function $(i){return i.replace(/<think>[\s\S]*?<\/think>/g,"").trim()}async function re(i,e,n){let{lmstudioEndpoint:r,lmStudioModel:t,stripReasoning:o}=i;try{let l=(await(0,N.requestUrl)({url:`${r}/v1/chat/completions`,method:"POST",contentType:"application/json",body:JSON.stringify({model:t,messages:[{role:"system",content:n},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content;return l&&(o?$(l):l)}catch(s){console.error("Coffee Rewriter \u2013 LM Studio error",s),new N.Notice("Coffee Rewriter: Could not reach LM Studio server.");return}}async function oe(i){let{lmstudioEndpoint:e}=i;try{let r=(await(0,N.requestUrl)({url:`${e}/v1/models`,method:"GET",contentType:"application/json"})).json;return r&&Array.isArray(r.data)?r.data.map(t=>t.id).filter(Boolean):[]}catch(n){return console.error("Coffee Rewriter \u2013 LM Studio models",n),[]}}var E=require("obsidian");async function se(i,e,n){let{claudeKey:r,claudeModel:t}=i;if(!r){new E.Notice("Coffee Rewriter: Claude API key missing. Add it in the settings.");return}try{let s=(await(0,E.requestUrl)({url:"https://api.anthropic.com/v1/messages",method:"POST",contentType:"application/json",headers:{"x-api-key":r,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:t,max_tokens:2048,system:n,messages:[{role:"user",content:e}]})})).json?.content?.[0];return s&&s.type==="text"?s.text:void 0}catch(o){console.error("Coffee Rewriter \u2013 Claude error",o),new E.Notice("Coffee Rewriter: Claude request failed (see console).");return}}async function le(i){let{claudeKey:e}=i;if(!e)return[];try{let r=(await(0,E.requestUrl)({url:"https://api.anthropic.com/v1/models",method:"GET",contentType:"application/json",headers:{"x-api-key":e,"anthropic-version":"2023-06-01"}})).json;return r&&Array.isArray(r.data)?r.data.map(t=>t.id).filter(Boolean):[]}catch(n){return console.error("Coffee Rewriter \u2013 Claude models error",n),[]}}var D=require("obsidian");async function ae(i,e,n){let{ollamaEndpoint:r,ollamaModel:t,stripReasoning:o}=i;try{let l=(await(0,D.requestUrl)({url:`${r}/v1/chat/completions`,method:"POST",contentType:"application/json",body:JSON.stringify({model:t,messages:[{role:"system",content:n},{role:"user",content:e}]})})).json?.choices?.[0]?.message?.content;return l&&(o?$(l):l)}catch(s){console.error("Coffee Rewriter \u2013 Ollama error",s),new D.Notice("Coffee Rewriter: Could not reach Ollama server.");return}}async function pe(i){let{ollamaEndpoint:e}=i;try{let r=(await(0,D.requestUrl)({url:`${e}/v1/models`,method:"GET",contentType:"application/json"})).json;return r&&Array.isArray(r.data)?r.data.map(t=>t.id).filter(Boolean):[]}catch(n){return console.error("Coffee Rewriter \u2013 Ollama models",n),[]}}var C=require("obsidian"),F=class extends C.Modal{plugin;template;isNew;onSave;nameInput;promptInput;constructor(e,n,r,t){super(e),this.plugin=n,this.onSave=t,r?(this.isNew=!1,this.template={...r}):(this.isNew=!0,this.template={id:`custom-${new Date().getTime()}`,name:"",prompt:""})}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("coffee-prompt-edit-modal"),e.createEl("h2",{text:this.isNew?"Add New Prompt Template":"Edit Prompt Template"});let n=!this.isNew&&this.plugin.cfg.promptTemplates.length>0&&this.plugin.cfg.promptTemplates[0].id===this.template.id;n||new C.Setting(e).setName("Template Name").addText(r=>{this.nameInput=r,r.setValue(this.template.name).setPlaceholder("Enter template name (e.g., Summarize for Twitter)")}),new C.Setting(e).setName("Prompt Content"),this.promptInput=new C.TextAreaComponent(e).setValue(this.template.prompt).setPlaceholder("Enter the full prompt here. The selected text will be appended when used."),this.promptInput.inputEl.rows=8,this.promptInput.inputEl.addClass("coffee-settings-prompt-textarea"),this.promptInput.inputEl.style.width="100%",this.promptInput.inputEl.style.marginTop="var(--size-2-2)",new C.Setting(e).addButton(r=>r.setButtonText("Save").setCta().onClick(()=>{if(this.nameInput&&(this.template.name=this.nameInput.getValue().trim()),this.template.prompt=this.promptInput.getValue().trim(),!this.template.name&&!n){new C.Notice("Template name cannot be empty.");return}else n&&(this.template.name=this.plugin.cfg.promptTemplates[0].name);if(!this.template.prompt){new C.Notice("Prompt content cannot be empty.");return}this.onSave({action:"save",template:this.template}),this.close()})).addButton(r=>r.setButtonText("Cancel").onClick(()=>{this.close()}))}onClose(){let{contentEl:e}=this;e.empty()}};var B={provider:"openai",openAiKey:"",openAiModel:"gpt-3.5-turbo",geminiKey:"",geminiModel:"gemini-pro",lmstudioEndpoint:"http://localhost:1234",lmStudioModel:"",promptTemplates:[{id:"default-quick-rewrite",name:"Quick Rewrite",prompt:"Improve clarity, grammar, and conciseness of the following text."},{id:"pirate-speak",name:"Pirate Speak",prompt:"Rewrite the following text as if you were a swashbuckling pirate, arrr! Keep the core meaning but infuse it with pirate slang and bravado."},{id:"professional-tone",name:"Professional Tone",prompt:"Please rewrite the following text in a more professional and formal tone. Ensure clarity, conciseness, and appropriate business language. Avoid jargon where possible, or explain it if necessary."},{id:"academic-phd-style",name:"Academic (PhD Style)",prompt:"Please revise the following text to reflect the style, depth, and rigor of a PhD-level academic paper. Focus on sophisticated vocabulary, nuanced argumentation, formal scholarly tone, and logical precision."}],preserveQuotes:!1,stripReasoning:!1,claudeKey:"",claudeModel:"claude-3-haiku-20240307",ollamaEndpoint:"http://localhost:11434",ollamaModel:""},j=class extends h.PluginSettingTab{plugin;selectedTemplateIdForEditing=null;promptTemplateSettingsContainer;constructor(e,n){super(e,n),this.plugin=n,this.plugin.cfg.promptTemplates&&this.plugin.cfg.promptTemplates.length>0&&(this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id)}addTextSetting(e,n,r,t,o,s=!1){new h.Setting(e).setName(n).setDesc(r).addText(l=>{s&&(l.inputEl.type="password"),l.setValue(t()).onChange(async a=>{o(a.trim()),await this.plugin.saveSettings()})})}async addModelDropdownSetting(e,n,r,t,o,s){let l=new h.Setting(e).setName(n).setDesc(r),a=null,d=null,c=async p=>{if(!a)return;let m=!1,w="API Key",f="";switch(t){case"openai":m=!!this.plugin.cfg.openAiKey,w="API Key",f="OpenAI API Key";break;case"gemini":m=!!this.plugin.cfg.geminiKey,w="API Key",f="Gemini API Key";break;case"claude":m=!!this.plugin.cfg.claudeKey,w="API Key",f="Claude API Key";break;case"lmstudio":m=!!this.plugin.cfg.lmstudioEndpoint,w="Server URL",f="LM Studio Server URL";break;case"ollama":m=!!this.plugin.cfg.ollamaEndpoint,w="Server URL",f="Ollama Server URL";break;default:a.selectEl.options.length=0,a.addOption("","--Provider error--"),a.setValue(""),a.selectEl.disabled=!0,d&&d.setDisabled(!0),l.setDesc(r+" (Unknown provider configuration)");return}let v=`--Set ${w} First--`,L=`Set ${f} to load models`;if(!m){a.selectEl.options.length=0,a.addOption("",v),a.setValue(""),a.selectEl.disabled=!0,d&&d.setDisabled(!0),l.setDesc(r+` (${L})`);return}a.selectEl.disabled=!0,d&&d.setDisabled(!0),l.setDesc(r+(p?" (Refreshing models...)":" (Loading models...)"));let u=[];try{switch(t){case"openai":u=await te(this.plugin.cfg);break;case"gemini":u=await ie(this.plugin.cfg),u=u.map(T=>T.startsWith("models/")?T.split("/")[1]:T);break;case"claude":u=await le(this.plugin.cfg);break;case"lmstudio":u=await oe(this.plugin.cfg);break;case"ollama":u=await pe(this.plugin.cfg);break}}catch(T){new h.Notice(`Failed to load models for ${t}. Check console.`),console.error(`Coffee Rewriter - Error loading models for ${t}:`,T)}l.setDesc(r),a.selectEl.disabled=!1,d&&d.setDisabled(!1),a.selectEl.options.length=0,u.length===0?a.addOption("","--No models found or loaded--"):(a.addOption("","--Select Model--"),u.forEach(T=>{a&&a.addOption(T,T)})),a.setValue(o())};l.addDropdown(async p=>{a=p,p.selectEl.options.length=0,p.addOption("","--Select Model--"),p.setValue(o()),p.onChange(async m=>{s(m),await this.plugin.saveSettings()}),await c(!1)}),l.addButton(p=>{d=p,p.setIcon("refresh-cw").setTooltip("Refresh model list").onClick(async()=>{await c(!0)})})}renderPromptTemplateEditor(){this.promptTemplateSettingsContainer.empty(),(!this.plugin.cfg.promptTemplates||this.plugin.cfg.promptTemplates.length===0)&&(this.plugin.cfg.promptTemplates=B.promptTemplates.map(t=>({...t})),this.plugin.saveSettings(),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates.length>0?this.plugin.cfg.promptTemplates[0].id:null),!this.selectedTemplateIdForEditing&&this.plugin.cfg.promptTemplates.length>0?this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id:this.plugin.cfg.promptTemplates.length===0&&(this.selectedTemplateIdForEditing=null);let e=new h.Setting(this.promptTemplateSettingsContainer).setName("Manage Templates");e.addButton(t=>t.setIcon("plus").setTooltip("Add new prompt template").setCta().onClick(()=>{new F(this.app,this.plugin,null,this.handlePromptSaveAction.bind(this)).open()})),e.addDropdown(t=>{this.plugin.cfg.promptTemplates.length===0?(t.addOption("__none__","-- No templates defined --"),t.setDisabled(!0)):this.plugin.cfg.promptTemplates.forEach(o=>{t.addOption(o.id,o.name)}),this.selectedTemplateIdForEditing?t.setValue(this.selectedTemplateIdForEditing):this.plugin.cfg.promptTemplates.length>0&&(t.setValue(this.plugin.cfg.promptTemplates[0].id),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id),t.onChange(async o=>{this.selectedTemplateIdForEditing=o,this.renderPromptTemplateEditor()})}),e.addButton(t=>t.setIcon("pencil").setTooltip("Edit selected prompt template").onClick(()=>{let o=this.plugin.cfg.promptTemplates.find(s=>s.id===this.selectedTemplateIdForEditing);o?new F(this.app,this.plugin,o,this.handlePromptSaveAction.bind(this)).open():new h.Notice("No template selected to edit. Please add one first if the list is empty.")}));let n=this.plugin.cfg.promptTemplates.find(t=>t.id===this.selectedTemplateIdForEditing),r=n?this.plugin.cfg.promptTemplates.indexOf(n)===0:!1;if(n&&!r&&e.addButton(t=>t.setIcon("trash").setTooltip("Delete selected prompt template").setWarning().onClick(async()=>{let o=this.plugin.cfg.promptTemplates.findIndex(s=>s.id===this.selectedTemplateIdForEditing);o>0?(this.plugin.cfg.promptTemplates.splice(o,1),this.selectedTemplateIdForEditing=this.plugin.cfg.promptTemplates[0].id,await this.plugin.saveSettings(),this.renderPromptTemplateEditor()):new h.Notice("Cannot delete this template.")})),n){new h.Setting(this.promptTemplateSettingsContainer).setName("Selected Prompt Content").setDesc("Content of the template selected above. Click the pencil icon to edit.");let t=this.promptTemplateSettingsContainer.createDiv({cls:"coffee-prompt-display-box"});t.setText(n.prompt),t.style.width="100%",t.style.padding="var(--size-2-3)",t.style.border="1px solid var(--background-modifier-border)",t.style.borderRadius="var(--radius-m)",t.style.backgroundColor="var(--background-secondary)",t.style.whiteSpace="pre-wrap",t.style.wordBreak="break-word",t.style.maxHeight="150px",t.style.overflowY="auto",t.style.marginTop="var(--size-2-2)",t.style.marginBottom="var(--size-4-4)"}else this.plugin.cfg.promptTemplates.length>0&&this.selectedTemplateIdForEditing&&new h.Setting(this.promptTemplateSettingsContainer).setName("Error").setDesc("Could not display selected prompt. Please try selecting again.")}async handlePromptSaveAction(e){let n=!1,r=this.selectedTemplateIdForEditing;if(e.action==="save"){let{template:t}=e,o=this.plugin.cfg.promptTemplates.findIndex(s=>s.id===t.id);o>-1?this.plugin.cfg.promptTemplates[o]=t:(this.plugin.cfg.promptTemplates.push(t),r=t.id),n=!0}n&&(this.selectedTemplateIdForEditing=r,await this.plugin.saveSettings(),this.renderPromptTemplateEditor())}display(){let{containerEl:e}=this;e.empty(),e.createEl("h3",{text:"LLM Provider Settings"}),new h.Setting(e).setName("LLM Provider").setDesc("Choose which backend to use for rewriting.").addDropdown(t=>{t.addOption("openai","OpenAI"),t.addOption("gemini","Gemini"),t.addOption("lmstudio","LM Studio"),t.addOption("claude","Claude (Anthropic)"),t.addOption("ollama","Ollama"),t.setValue(this.plugin.cfg.provider).onChange(async o=>{this.plugin.cfg.provider=o,await this.plugin.saveSettings(),this.display()})});let n=this.plugin.cfg.provider;n==="openai"?(this.addTextSetting(e,"API Key","Your OpenAI secret key.",()=>this.plugin.cfg.openAiKey,t=>this.plugin.cfg.openAiKey=t,!0),this.addModelDropdownSetting(e,"Model","OpenAI model.","openai",()=>this.plugin.cfg.openAiModel,t=>this.plugin.cfg.openAiModel=t)):n==="gemini"?(this.addTextSetting(e,"API Key","Google AI API key.",()=>this.plugin.cfg.geminiKey,t=>this.plugin.cfg.geminiKey=t,!0),this.addModelDropdownSetting(e,"Model","Gemini model.","gemini",()=>this.plugin.cfg.geminiModel,t=>this.plugin.cfg.geminiModel=t)):n==="lmstudio"?(this.addTextSetting(e,"Server URL","LM Studio endpoint (http://host:port)",()=>this.plugin.cfg.lmstudioEndpoint,t=>this.plugin.cfg.lmstudioEndpoint=t),this.addModelDropdownSetting(e,"Model","LM Studio model (requires server to be running).","lmstudio",()=>this.plugin.cfg.lmStudioModel,t=>this.plugin.cfg.lmStudioModel=t)):n==="claude"?(this.addTextSetting(e,"API Key","Your Anthropic Claude API key.",()=>this.plugin.cfg.claudeKey,t=>this.plugin.cfg.claudeKey=t,!0),this.addModelDropdownSetting(e,"Model","Claude model.","claude",()=>this.plugin.cfg.claudeModel,t=>this.plugin.cfg.claudeModel=t)):n==="ollama"&&(this.addTextSetting(e,"Server URL","Ollama endpoint (http://host:port)",()=>this.plugin.cfg.ollamaEndpoint,t=>this.plugin.cfg.ollamaEndpoint=t),this.addModelDropdownSetting(e,"Model","Ollama model (requires server to be running).","ollama",()=>this.plugin.cfg.ollamaModel,t=>this.plugin.cfg.ollamaModel=t)),e.createEl("h3",{text:"Prompts"}),this.promptTemplateSettingsContainer=e.createDiv("prompt-templates-settings-area"),this.renderPromptTemplateEditor(),e.createEl("h3",{text:"Other Settings"}),new h.Setting(e).setName("Preserve text inside quotes").setDesc('Do not rewrite text that is wrapped in "double quotes".').addToggle(t=>t.setValue(this.plugin.cfg.preserveQuotes).onChange(async o=>{this.plugin.cfg.preserveQuotes=o,await this.plugin.saveSettings()})),(n==="lmstudio"||n==="ollama")&&new h.Setting(e).setName("Strip <think> reasoning (local models)").setDesc("If your local model emits <think>...</think> blocks, strip them from the final output.").addToggle(t=>t.setValue(this.plugin.cfg.stripReasoning).onChange(async o=>{this.plugin.cfg.stripReasoning=o,await this.plugin.saveSettings()}))}};function Se(i){return`${i.trim()} Reply with ONLY ONE JSON object containing two fields: "rewrittenText" (containing the entire improved version as a single string, including any lists or paragraphs) and "note" (containing a brief note about what was changed). Always return a single, valid JSON object. Do not return a list of JSON objects.`}function Le(i){if(i)try{let e=i.match(/\{[\s\S]*\}/);if(e){let n=e[0],r=JSON.parse(n);if(typeof r.rewrittenText=="string"&&typeof r.note=="string")return r}return{rewrittenText:i.trim(),note:"The AI didn't provide structured feedback for this rewrite."}}catch(e){return console.warn("Coffee Rewriter - Failed to parse LLM response as JSON:",e),{rewrittenText:i.trim(),note:"The AI didn't provide structured feedback for this rewrite."}}}async function U(i,e,n){let r;n!==void 0?r=n:i.promptTemplates&&i.promptTemplates.length>0&&i.promptTemplates[0]&&typeof i.promptTemplates[0].prompt=="string"?r=i.promptTemplates[0].prompt:(console.warn("Coffee Rewriter: Default prompt template not found or invalid. Using a fallback prompt."),r="Improve the following text.");let t=Se(r),o;switch(i.provider){case"openai":o=await ee(i,e,t);break;case"gemini":o=await ne(i,e,t);break;case"lmstudio":o=await re(i,e,t);break;case"claude":o=await se(i,e,t);break;case"ollama":o=await ae(i,e,t);break;default:console.warn(`Coffee Rewriter: Unknown provider: ${i.provider}`);return}return Le(o)}var fe=require("obsidian"),de;function b(i,e=4e3){de?.hide(),de=new fe.Notice(i,e)}var S=require("obsidian");function x(){}x.prototype={diff:function(e,n){var r,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},o=t.callback;typeof t=="function"&&(o=t,t={}),this.options=t;var s=this;function l(g){return o?(setTimeout(function(){o(void 0,g)},0),!0):g}e=this.castInput(e),n=this.castInput(n),e=this.removeEmpty(this.tokenize(e)),n=this.removeEmpty(this.tokenize(n));var a=n.length,d=e.length,c=1,p=a+d;t.maxEditLength&&(p=Math.min(p,t.maxEditLength));var m=(r=t.timeout)!==null&&r!==void 0?r:1/0,w=Date.now()+m,f=[{oldPos:-1,lastComponent:void 0}],v=this.extractCommon(f[0],n,e,0);if(f[0].oldPos+1>=d&&v+1>=a)return l([{value:this.join(n),count:n.length}]);var L=-1/0,u=1/0;function T(){for(var g=Math.max(L,-c);g<=Math.min(u,c);g+=2){var A=void 0,M=f[g-1],O=f[g+1];M&&(f[g-1]=void 0);var G=!1;if(O){var Z=O.oldPos-g;G=O&&0<=Z&&Z<a}var _=M&&M.oldPos+1<d;if(!G&&!_){f[g]=void 0;continue}if(!_||G&&M.oldPos+1<O.oldPos?A=s.addToPath(O,!0,void 0,0):A=s.addToPath(M,void 0,!0,1),v=s.extractCommon(A,n,e,g),A.oldPos+1>=d&&v+1>=a)return l(Ae(s,A.lastComponent,n,e,s.useLongestToken));f[g]=A,A.oldPos+1>=d&&(u=Math.min(u,g-1)),v+1>=a&&(L=Math.max(L,g+1))}c++}if(o)(function g(){setTimeout(function(){if(c>p||Date.now()>w)return o();T()||g()},0)})();else for(;c<=p&&Date.now()<=w;){var X=T();if(X)return X}},addToPath:function(e,n,r,t){var o=e.lastComponent;return o&&o.added===n&&o.removed===r?{oldPos:e.oldPos+t,lastComponent:{count:o.count+1,added:n,removed:r,previousComponent:o.previousComponent}}:{oldPos:e.oldPos+t,lastComponent:{count:1,added:n,removed:r,previousComponent:o}}},extractCommon:function(e,n,r,t){for(var o=n.length,s=r.length,l=e.oldPos,a=l-t,d=0;a+1<o&&l+1<s&&this.equals(n[a+1],r[l+1]);)a++,l++,d++;return d&&(e.lastComponent={count:d,previousComponent:e.lastComponent}),e.oldPos=l,a},equals:function(e,n){return this.options.comparator?this.options.comparator(e,n):e===n||this.options.ignoreCase&&e.toLowerCase()===n.toLowerCase()},removeEmpty:function(e){for(var n=[],r=0;r<e.length;r++)e[r]&&n.push(e[r]);return n},castInput:function(e){return e},tokenize:function(e){return e.split("")},join:function(e){return e.join("")}};function Ae(i,e,n,r,t){for(var o=[],s;e;)o.push(e),s=e.previousComponent,delete e.previousComponent,e=s;o.reverse();for(var l=0,a=o.length,d=0,c=0;l<a;l++){var p=o[l];if(p.removed){if(p.value=i.join(r.slice(c,c+p.count)),c+=p.count,l&&o[l-1].added){var w=o[l-1];o[l-1]=o[l],o[l]=w}}else{if(!p.added&&t){var m=n.slice(d,d+p.count);m=m.map(function(v,L){var u=r[c+L];return u.length>v.length?u:v}),p.value=i.join(m)}else p.value=i.join(n.slice(d,d+p.count));d+=p.count,p.added||(c+=p.count)}}var f=o[a-1];return a>1&&typeof f.value=="string"&&(f.added||f.removed)&&i.equals("",f.value)&&(o[a-2].value+=f.value,o.pop()),o}var pt=new x;function Re(i,e){if(typeof i=="function")e.callback=i;else if(i)for(var n in i)i.hasOwnProperty(n)&&(e[n]=i[n]);return e}var ce=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,me=/\S/,Q=new x;Q.equals=function(i,e){return this.options.ignoreCase&&(i=i.toLowerCase(),e=e.toLowerCase()),i===e||this.options.ignoreWhitespace&&!me.test(i)&&!me.test(e)};Q.tokenize=function(i){for(var e=i.split(/([^\S\r\n]+|[()[\]{}'"\r\n]|\b)/),n=0;n<e.length-1;n++)!e[n+1]&&e[n+2]&&ce.test(e[n])&&ce.test(e[n+2])&&(e[n]+=e[n+2],e.splice(n+1,2),n--);return e};function ue(i,e,n){return n=Re(n,{ignoreWhitespace:!0}),Q.diff(i,e,n)}var ge=new x;ge.tokenize=function(i){this.options.stripTrailingCr&&(i=i.replace(/\r\n/g,`
`));var e=[],n=i.split(/(\n|\r\n)/);n[n.length-1]||n.pop();for(var r=0;r<n.length;r++){var t=n[r];r%2&&!this.options.newlineIsToken?e[e.length-1]+=t:(this.options.ignoreWhitespace&&(t=t.trim()),e.push(t))}return e};var Pe=new x;Pe.tokenize=function(i){return i.split(/(\S.+?[.!?])(?=\s+|$)/)};var Ee=new x;Ee.tokenize=function(i){return i.split(/([{}:;,]|\s+)/)};function K(i){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?K=function(e){return typeof e}:K=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},K(i)}var be=Object.prototype.toString,k=new x;k.useLongestToken=!0;k.tokenize=ge.tokenize;k.castInput=function(i){var e=this.options,n=e.undefinedReplacement,r=e.stringifyReplacer,t=r===void 0?function(o,s){return typeof s>"u"?n:s}:r;return typeof i=="string"?i:JSON.stringify(V(i,null,null,t),t,"  ")};k.equals=function(i,e){return x.prototype.equals.call(k,i.replace(/,([\r\n])/g,"$1"),e.replace(/,([\r\n])/g,"$1"))};function V(i,e,n,r,t){e=e||[],n=n||[],r&&(i=r(t,i));var o;for(o=0;o<e.length;o+=1)if(e[o]===i)return n[o];var s;if(be.call(i)==="[object Array]"){for(e.push(i),s=new Array(i.length),n.push(s),o=0;o<i.length;o+=1)s[o]=V(i[o],e,n,r,t);return e.pop(),n.pop(),s}if(i&&i.toJSON&&(i=i.toJSON()),K(i)==="object"&&i!==null){e.push(i),s={},n.push(s);var l=[],a;for(a in i)i.hasOwnProperty(a)&&l.push(a);for(l.sort(),o=0;o<l.length;o+=1)a=l[o],s[a]=V(i[a],e,n,r,a);e.pop(),n.pop()}else s=i;return s}var W=new x;W.tokenize=function(i){return i.slice()};W.join=W.removeEmpty=function(i){return i};function he(i,e){let n=0,r=0;return{annotated:ue(i,e).map(o=>{if(o.added){n+=1;let s=o.value,l=s.match(/^(\s*)/),a=l?l[0]:"",d=s.match(/(\s*)$/),c=d?d[0]:"",p=s;return c.length>0&&(p=p.substring(0,p.length-c.length)),a.length>0&&(p=p.substring(a.length)),p.length>0?`${a}<mark>${p}</mark>${c}`:`<mark>${s}</mark>`}return o.removed?(r+=1,""):o.value}).join(""),additions:n,removals:r}}var I=class extends S.Modal{originalText;rewrittenText;rewriteNote;onAcceptAll;showDiff;constructor(e,n,r,t,o=!0,s){super(e),this.originalText=n,this.rewrittenText=r,this.rewriteNote=s,this.onAcceptAll=t,this.showDiff=o}onOpen(){let{contentEl:e}=this;if(e.empty(),e.addClass("coffee-rewrite-modal"),e.createEl("h2",{text:"Review Rewrite"}),this.rewriteNote){let l=e.createDiv("note-container");l.createEl("h4",{text:"Note from the AI"}),l.createDiv("note-content").setText(this.rewriteNote)}let n=e.createDiv("text-container original-text-container");n.createEl("h4",{text:"Original"});let r=n.createDiv("modal-text-content");S.MarkdownRenderer.render(this.app,this.originalText,r,"",this);let t=e.createDiv("text-container rewritten-text-container"),o=this.showDiff?"Rewritten (changes highlighted)":"Rewritten Text";t.createEl("h4",{text:o});let s=t.createDiv("modal-text-content");if(this.showDiff){let a=he(this.originalText,this.rewrittenText).annotated;S.MarkdownRenderer.render(this.app,a,s,"",this)}else S.MarkdownRenderer.render(this.app,this.rewrittenText,s,"",this);new S.Setting(e).addButton(l=>l.setButtonText("Accept").setCta().onClick(()=>{this.onAcceptAll(this.rewrittenText),this.close()})).addButton(l=>l.setButtonText("Cancel").onClick(()=>{this.close()}))}onClose(){let{contentEl:e}=this;e.empty()}};async function Y(i,e){let n=e.getSelection(),r=!!n,t=n||e.getLine(e.getCursor().line),o=e.getCursor().line,s=r?null:e.getLine(o);if(!t.trim()){b("Coffee Rewriter: Nothing to rewrite.");return}b("\u2615\uFE0F Calling LLM to rewrite text...");let l=await U(i.cfg,t);if(!l){b("Coffee Rewriter: Rewrite request failed or returned empty.");return}let a=l.rewrittenText.trim(),d=l.note;if(a===t.trim()){b("\u2705 Text looks good, nothing to change.");return}let c=a;if(i.cfg.preserveQuotes){let m=t.match(/"([^"]+)"/g)||[],w=c.match(/"([^"]+)"/g)||[];if(m.length===w.length){let f=c;for(let v=0;v<m.length;v++)f=f.replace(w[v],m[v]);c=f}}let p=m=>{r?e.replaceSelection(m):s!==null&&e.replaceRange(m,{line:o,ch:0},{line:o,ch:s.length}),b("\u2615\uFE0F Rewrite accepted!")};new I(i.app,t,c,p,!0,d).open()}var y=require("obsidian");var H=class extends y.Modal{selectedText;plugin;editor;promptTextArea;promptSelect;customPromptContainer;chosenPromptTemplate=null;CUSTOM_PROMPT_ID="__custom__";promptPreviewArea;constructor(e,n,r,t){super(e),this.selectedText=n,this.plugin=r,this.editor=t}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("coffee-tailored-prompt-modal"),e.createEl("h2",{text:"Tailored Rewrite"}),e.createEl("p",{text:"Select a prompt template or write your own:"});let n=new y.Setting(e).setName("Prompt Template");this.promptPreviewArea=e.createDiv(),this.promptPreviewArea.addClass("coffee-tailored-prompt-preview"),this.promptPreviewArea.style.display="none",this.customPromptContainer=e.createDiv("custom-prompt-container-div"),this.customPromptContainer.addClass("coffee-tailored-custom-prompt-container"),this.customPromptContainer.style.display="none",n.addDropdown(t=>{this.promptSelect=t,this.plugin.cfg.promptTemplates.forEach(s=>{t.addOption(s.id,s.name)}),t.addOption(this.CUSTOM_PROMPT_ID,"-- Write a new custom prompt --");let o=!0;this.plugin.cfg.promptTemplates.length>0?(t.setValue(this.plugin.cfg.promptTemplates[0].id),this.chosenPromptTemplate=this.plugin.cfg.promptTemplates[0],o=!1):t.setValue(this.CUSTOM_PROMPT_ID),this.toggleCustomPromptUI(o),this.updatePromptPreview(t.getValue()),t.onChange(s=>{let l=s===this.CUSTOM_PROMPT_ID;l?this.chosenPromptTemplate=null:this.chosenPromptTemplate=this.plugin.cfg.promptTemplates.find(a=>a.id===s)||null,this.toggleCustomPromptUI(l),this.updatePromptPreview(s)})}),new y.Setting(this.customPromptContainer).setName("Custom Prompt").setDesc("Enter your custom prompt. The selected text will be appended to this.").addTextArea(t=>{this.promptTextArea=t,t.inputEl.rows=5,t.inputEl.cols=50,t.setPlaceholder("Example: Summarize this text for a 5-year-old."),t.inputEl.addClass("coffee-tailored-prompt-textarea")}),new y.Setting(e).addButton(t=>t.setButtonText("Rewrite with this prompt").setCta().onClick(()=>{let o="";if(this.chosenPromptTemplate)o=this.chosenPromptTemplate.prompt;else if(this.promptTextArea.getValue().trim())o=this.promptTextArea.getValue().trim();else{new y.Notice("Please select a template or enter a custom prompt.");return}this.close(),this.handleRewrite(o)}))}toggleCustomPromptUI(e){this.customPromptContainer&&this.promptPreviewArea&&(e?(this.customPromptContainer.style.display="block",this.promptPreviewArea.style.display="none"):(this.customPromptContainer.style.display="none",this.promptPreviewArea.style.display="block"))}updatePromptPreview(e){if(this.promptPreviewArea)if(e&&e!==this.CUSTOM_PROMPT_ID){let n=this.plugin.cfg.promptTemplates.find(r=>r.id===e);n?this.promptPreviewArea.textContent=n.prompt:this.promptPreviewArea.textContent="Prompt not found."}else this.promptPreviewArea.textContent=""}async handleRewrite(e){new y.Notice("\u2615\uFE0F Calling LLM with tailored prompt...");let n=await U(this.plugin.cfg,this.selectedText,e);if(!n){new y.Notice("Coffee Rewriter: Tailored rewrite request failed or returned empty.");return}let r=n.rewrittenText,t=n.note,o=r.trim();if(o===this.selectedText.trim()){new y.Notice("\u2705 Text looks good, tailored prompt resulted in no changes.");return}let s=l=>{if(this.editor.getSelection()===this.selectedText)this.editor.replaceSelection(l);else{let d=this.editor.listSelections()[0];if(d)this.editor.replaceRange(l,d.anchor,d.head);else{new y.Notice("Could not apply rewrite: editor selection changed.");return}}new y.Notice("\u2615\uFE0F Tailored rewrite accepted!")};new I(this.app,this.selectedText,o,s,!1,t).open()}onClose(){let{contentEl:e}=this;e.empty()}};var z=class extends q.Plugin{settings=B;async onload(){await this.loadSettings(),this.addSettingTab(new j(this.app,this)),this.addCommand({id:"coffee-quick-rewrite",name:"Quick Rewrite (Paragraph / Selection)",editorCallback:e=>Y(this,e),icon:"bot"}),this.addCommand({id:"coffee-tailored-rewrite",name:"Tailored rewrite",editorCallback:e=>{let n=e.getSelection()||e.getLine(e.getCursor().line);if(!n.trim()){new q.Notice("Nothing selected to rewrite.");return}new H(this.app,n,this,e).open()},icon:"edit"}),this.registerEvent(this.app.workspace.on("editor-menu",(e,n)=>{e.addItem(r=>{r.setTitle("Quick Rewrite (Paragraph / Selection)").setIcon("bot").onClick(()=>Y(this,n))}),e.addItem(r=>{r.setTitle("Tailored rewrite").setIcon("bot").onClick(()=>{let t=n.getSelection()||n.getLine(n.getCursor().line);if(!t.trim()){new q.Notice("Nothing selected to rewrite.");return}new H(this.app,t,this,n).open()})})})),console.info("Coffee Rewriter loaded \u2615\uFE0F")}onunload(){console.info("Coffee Rewriter unloaded \u2615\uFE0F")}async loadSettings(){this.settings=Object.assign({},B,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}get cfg(){return this.settings}};
